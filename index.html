<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Académico 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Outfit', 'sans-serif'] },
                extend: {
                    colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'bounce-slow': 'bounce 3s infinite' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
        }

        .hidden-view {
            display: none !important;
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <!-- HEADER / NAVIGATION -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Brand -->
                <div class="flex items-center gap-3 cursor-pointer group" onclick="app.navigateTo('dashboard-view')">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-brand-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30 group-hover:scale-105 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div>
                        <h1
                            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600">
                            Registro 2026</h1>
                        <p class="text-xs text-slate-400 font-medium">Gestión Académica</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-4">
                    <!-- Level Selector -->
                    <div class="relative">
                        <select id="level-selector"
                            class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 py-1.5 pl-4 pr-8 rounded-xl text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500/20 cursor-pointer hover:bg-white transition-colors">
                            <option value="7">Nivel 7</option>
                            <option value="8">Nivel 8</option>
                            <option value="9">Nivel 9</option>
                            <option value="10">Nivel 10</option>
                            <option value="11">Nivel 11</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Period Toggle -->
                    <div class="bg-gray-100 p-1 rounded-xl flex shadow-inner">
                        <button id="period-1-btn" onclick="app.setPeriod(1)"
                            class="px-4 py-1.5 text-sm font-bold rounded-xl transition-all shadow-md bg-white ring-1 ring-gray-100 transform scale-105 text-brand-600">I
                            Periodo</button>
                        <button id="period-2-btn" onclick="app.setPeriod(2)"
                            class="px-4 py-1.5 text-sm font-medium rounded-xl transition-all text-gray-400 hover:text-gray-600 hover:bg-white/50">II
                            Periodo</button>
                    </div>

                    <!-- Config Button -->
                    <button onclick="app.navigateTo('config-view')"
                        class="hidden md:flex items-center gap-2 px-3 py-2 text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all group"
                        title="Gestionar Grupo">
                        <span class="text-sm font-bold text-gray-500 group-hover:text-brand-600">Gestionar Grupo</span>
                        <div
                            class="bg-gray-100 p-1.5 rounded-lg group-hover:bg-white group-hover:shadow-sm transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                    </button>
                    <!-- Mobile Icon Only -->
                    <button onclick="app.navigateTo('config-view')"
                        class="md:hidden p-2 text-gray-400 hover:text-slate-600 hover:bg-gray-100 rounded-xl transition-all"
                        title="Gestionar Grupo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full relative">

        <!-- VIEW: DASHBOARD -->
        <section id="dashboard-view" class="view-section animate-fade-in">
            <!-- Search -->
            <div class="mb-10 relative z-20">
                <div class="relative max-w-2xl mx-auto group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400 group-focus-within:text-brand-500 transition-colors"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" id="student-search"
                        class="block w-full pl-12 pr-4 py-4 bg-white border-0 rounded-2xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-500/50 shadow-lg shadow-gray-200/50 text-lg transition-all"
                        placeholder="Buscar estudiante por nombre...">

                    <!-- Search Results Dropdown -->
                    <div id="search-results"
                        class="absolute w-full mt-2 bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden hidden transform transition-all origin-top">
                    </div>
                </div>
            </div>

            <!-- Rubric Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- CARD: Trabajo Cotidiano -->
                <div onclick="app.navigateTo('cotidiano-view')"
                    class="bg-white rounded-3xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-blue-50 to-transparent rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Trabajo Cotidiano</h3>
                        <p class="text-sm text-slate-500">Prácticas y actividades diarias.</p>
                        <div class="mt-4 flex items-center justify-between">
                            <span class="text-xs font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded-lg"
                                id="percent-cotidiano">45% / 35%</span>
                            <span
                                class="flex items-center text-xs font-bold text-gray-300 group-hover:text-blue-500 transition-colors">
                                Abrir <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- CARD: Tareas (Placeholder) -->
                <div onclick="app.navigateTo('tareas-view')"
                    class="bg-white rounded-3xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-purple-50 to-transparent rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-purple-600 group-hover:text-white transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Tareas</h3>
                        <p class="text-sm text-slate-500">Asignaciones extraclase.</p>
                        <div class="mt-4 flex items-center justify-between">
                            <span class="text-xs font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded-lg">10%</span>
                        </div>
                    </div>
                </div>

                <!-- CARD: Pruebas -->
                <div onclick="app.navigateTo('pruebas-view')"
                    class="bg-white rounded-3xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-rose-50 to-transparent rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-rose-600 group-hover:text-white transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Pruebas</h3>
                        <p class="text-sm text-slate-500">Exámenes parciales.</p>
                        <div class="mt-4 flex items-center justify-between">
                            <span class="text-xs font-bold px-2 py-1 bg-rose-50 text-rose-600 rounded-lg"
                                id="percent-pruebas">40% / 50%</span>
                        </div>
                    </div>
                </div>

                <!-- CARD: Asistencia -->
                <div onclick="app.navigateTo('asistencia-view')"
                    class="bg-white rounded-3xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-emerald-50 to-transparent rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                    </div>
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">Asistencia</h3>
                        <p class="text-sm text-slate-500">Registro diario y ausencias.</p>
                        <div class="mt-4 flex items-center justify-between">
                            <span
                                class="text-xs font-bold px-2 py-1 bg-emerald-50 text-emerald-600 rounded-lg">5%</span>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- VIEW: CONFIGURATION (Students) -->
        <section id="config-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Estudiantes</h2>
                <button onclick="app.navigateTo('dashboard-view')"
                    class="text-sm text-slate-500 hover:text-brand-600 font-medium">Volver</button>
            </div>

            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-100 p-8">
                <!-- Add Manual -->
                <div class="mb-8 bg-gray-50 p-6 rounded-2xl border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4">Agregar Estudiante</h3>
                    <div class="flex gap-4">
                        <input type="text" id="new-student-id" placeholder="ID / Cédula"
                            class="flex-1 px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20">
                        <input type="text" id="new-student-name" placeholder="Nombre Completo"
                            class="flex-[2] px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20">
                        <button onclick="app.addStudentManual()"
                            class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-700 transition-colors shadow-lg shadow-slate-800/20">Agregar</button>
                    </div>
                </div>

                <!-- CSV Upload -->
                <div class="mb-8">
                    <label
                        class="block w-full cursor-pointer bg-brand-50 border-2 border-dashed border-brand-200 rounded-2xl p-8 text-center hover:bg-brand-100/50 transition-colors group">
                        <input type="file" id="csv-upload" accept=".csv" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-10 w-10 text-brand-400 mx-auto mb-2 group-hover:scale-110 transition-transform"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span class="text-brand-700 font-bold block">Importar CSV</span>
                        <span class="text-brand-400 text-xs">(Formato: ID, Nombre)</span>
                    </label>
                    <div class="mt-4 flex justify-between">
                        <button onclick="app.downloadTemplate()"
                            class="text-xs font-bold text-brand-600 hover:underline">Descargar Plantilla</button>
                        <button onclick="app.exportCSV()"
                            class="text-xs font-bold text-emerald-600 hover:underline flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exportar Datos
                        </button>
                    </div>
                </div>

                <!-- List -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Nombre</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="config-student-list" class="bg-white divide-y divide-gray-50">
                            <!-- Populated JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: STUDENT DETAIL (Ficha) -->
        <section id="student-view" class="view-section hidden-view animate-fade-in">
            <div class="mb-8 flex items-center justify-between">
                <button onclick="app.navigateTo('dashboard-view')"
                    class="text-sm text-slate-500 hover:text-brand-600 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Volver
                </button>
                <div class="text-right">
                    <h2 class="text-2xl font-bold text-slate-800" id="std-name">Nombre Estudiante</h2>
                    <p class="text-sm text-slate-400" id="std-id">ID: 12345</p>
                    <p class="text-xs font-bold text-brand-500 bg-brand-50 px-2 py-1 rounded inline-block mt-1"
                        id="std-level">Nivel X</p>
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Grades Breakdown -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Desglose de Notas</h3>
                        <div class="text-right">
                            <span class="block text-3xl font-extrabold text-brand-600" id="std-final-grade">0.00</span>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nota Final</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Cotidiano -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-600">Trabajo Cotidiano</span>
                                <span class="text-sm font-bold text-slate-800" id="std-grade-cotidiano">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-blue-500 h-2.5 rounded-full" style="width: 0%" id="std-bar-cotidiano">
                                </div>
                            </div>
                        </div>
                        <!-- Tareas -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-600">Tareas</span>
                                <span class="text-sm font-bold text-slate-800" id="std-grade-tareas">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-purple-500 h-2.5 rounded-full" style="width: 0%" id="std-bar-tareas">
                                </div>
                            </div>
                        </div>
                        <!-- Pruebas -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-600">Pruebas</span>
                                <span class="text-sm font-bold text-slate-800" id="std-grade-pruebas">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-rose-500 h-2.5 rounded-full" style="width: 0%" id="std-bar-pruebas">
                                </div>
                            </div>
                        </div>
                        <!-- Asistencia -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-600">Asistencia</span>
                                <span class="text-sm font-bold text-slate-800" id="std-grade-asistencia">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%"
                                    id="std-bar-asistencia"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Widget -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Historial de Asistencia</h3>
                            <div class="flex gap-3 mt-2">
                                <span
                                    class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded-lg border border-red-100"
                                    title="Ausencias Injustificadas">AI: <span id="std-att-ai">0</span></span>
                                <span
                                    class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg border border-blue-100"
                                    title="Ausencias Justificadas">AJ: <span id="std-att-aj">0</span></span>
                                <span
                                    class="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100"
                                    title="Tardías">T: <span id="std-att-t">0</span></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-2xl font-extrabold text-brand-600"
                                id="std-att-grade-badge">10%</span>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nota</span>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-64 pr-2">
                        <table class="w-full">
                            <tbody id="std-att-history-list" class="divide-y divide-gray-50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <p id="std-att-empty" class="text-center text-gray-400 text-sm py-4 hidden">Sin registros de
                            ausencias.</p>
                    </div>
                </div>
            </div>

            <!-- Cotidiano History Widget -->
            <div class="mt-6 bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Historial de Trabajo Cotidiano</h3>
                    <div class="text-right">
                        <span class="block text-xl font-extrabold text-blue-600" id="std-coti-grade-badge">0%</span>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nota</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Actividad</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Puntos</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Nota (0-3)</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Estado</th>
                            </tr>
                        </thead>
                        <tbody id="std-coti-history-list" class="divide-y divide-gray-50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <p id="std-coti-empty" class="text-center text-gray-400 text-sm py-4 hidden">Sin registros de
                        trabajo cotidiano.</p>
                </div>
            </div>

            <!-- Tareas History Widget -->
            <div class="mt-6 bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Historial de Tareas</h3>
                    <div class="text-right">
                        <span class="block text-xl font-extrabold text-purple-600" id="std-tareas-grade-badge">0%</span>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nota</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Tarea</th>
                            </tr>
                        </thead>
                        <tbody id="std-tareas-history-list" class="divide-y divide-gray-50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <p id="std-tareas-empty" class="text-center text-gray-400 text-sm py-4 hidden">Sin registros de
                        tareas.</p>
                </div>
            </div>

            <!-- Pruebas History Widget -->
            <div class="mt-6 bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Historial de Pruebas</h3>
                    <div class="text-right">
                        <span class="block text-xl font-extrabold text-indigo-600"
                            id="std-pruebas-grade-badge">0%</span>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nota</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Prueba</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Fecha</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Valor</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Nota</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    %</th>
                            </tr>
                        </thead>
                        <tbody id="std-pruebas-history-list" class="divide-y divide-gray-50"></tbody>
                    </table>
                    <p id="std-pruebas-empty" class="text-center text-gray-400 text-sm py-4 hidden">Sin registros de
                        pruebas.</p>
                </div>
            </div>
            <!-- Annual Summary (Footer) -->
            <div id="std-annual-summary" class="mt-8 mb-4 max-w-4xl mx-auto"></div>
        </section>



        <!-- VIEW: ATTENDANCE -->
        <section id="asistencia-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('dashboard-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver al Dashboard
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Control de Asistencia</h2>
                    <p class="text-slate-500 mt-1">Registro diario de lecciones.</p>
                </div>
                <button onclick="app.navigateTo('asistencia-summary-view')"
                    class="bg-white border border-gray-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    Ver Histórico
                </button>
            </div>

            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-50 p-8">
                <!-- Controls -->
                <div
                    class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-6 gap-4 border-b border-gray-50 pb-6">
                    <div class="flex items-center gap-4 bg-gray-50 p-2 rounded-2xl border border-gray-100">
                        <input type="date" id="att-date"
                            class="bg-white border-0 text-slate-700 font-bold rounded-xl px-4 py-2 text-sm focus:ring-0 shadow-sm"
                            onchange="app.renderAttendanceView()">
                        <div class="h-8 w-px bg-gray-200"></div>
                        <label for="att-total-lessons"
                            class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1 hidden sm:block">Lecciones</label>
                        <input type="number" id="att-total-lessons" value="2" min="1" max="10"
                            class="w-16 px-2 py-2 border border-gray-200 rounded-xl bg-white text-gray-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500/20 text-center"
                            onchange="app.updateTotalLessons(this.value)">
                        <button onclick="app.deleteAttendanceDate()"
                            class="text-red-400 hover:text-red-600 bg-white hover:bg-red-50 p-2 rounded-xl transition-all shadow-sm"
                            title="Borrar registro de esta fecha">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        </svg>
                        </button>
                    </div>
                    <div class="bg-blue-50 px-4 py-2 rounded-2xl border border-blue-100 flex items-center gap-2">
                        <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">Total Lecciones</span>
                        <span id="att-period-total-badge" class="text-lg font-extrabold text-blue-700">0</span>
                    </div>
                </div>

                <!-- List -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50/50">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 w-1/4">
                                    Estudiante</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Estado</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    Lecciones</th>
                                <th
                                    class="px-4 py-4 text-center text-xs font-bold text-red-500 uppercase tracking-wider bg-red-50/30">
                                    AI</th>
                                <th
                                    class="px-4 py-4 text-center text-xs font-bold text-blue-500 uppercase tracking-wider bg-blue-50/30">
                                    AJ</th>
                                <th
                                    class="px-4 py-4 text-center text-xs font-bold text-yellow-500 uppercase tracking-wider bg-yellow-50/30">
                                    T</th>
                                <th
                                    class="px-6 py-4 text-center text-xs font-bold text-slate-700 uppercase tracking-wider bg-gray-100/50">
                                    Nota</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list" class="bg-white divide-y divide-gray-50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: ATTENDANCE SUMMARY -->
        <section id="asistencia-summary-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('asistencia-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">Volver</button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Registro Histórico de Asistencia
                    </h2>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-50 p-8">
                <div id="att-summary-table-container"></div>
            </div>
        </section>

        <!-- VIEW: COTIDIANO (Everyday Work) -->
        <section id="cotidiano-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('dashboard-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver al Dashboard
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Trabajo Cotidiano</h2>
                    <p class="text-slate-500 mt-1">Gestión de Prácticas y Actividades.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="app.navigateTo('cotidiano-summary-view')"
                        class="bg-white border border-gray-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Ver Reporte
                    </button>
                    <button onclick="app.openActivityEditor()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nueva Actividad
                    </button>
                </div>
            </div>

            <!-- Activities Grid -->
            <div id="cotidiano-activities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Populated by JS -->
            </div>

        </section> <!-- End Cotidiano View -->

        <!-- VIEW: TAREAS (Assignments) -->
        <section id="tareas-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('dashboard-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver al Dashboard
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Tareas</h2>
                    <p class="text-slate-500 mt-1">Gestión de Tareas y Escalas Variables.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="app.navigateTo('tareas-summary-view')"
                        class="bg-white border border-gray-200 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Ver Reporte
                    </button>
                    <button onclick="app.openTareaEditor()"
                        class="bg-purple-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-purple-500/30 hover:bg-purple-700 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nueva Tarea
                    </button>
                </div>
            </div>
            <div id="tareas-activities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Tarea Editor Modal -->
        <div id="tarea-editor"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-xl font-bold text-slate-800">Editar Tarea</h3>
                    <button onclick="app.closeTareaEditor()" class="text-gray-400 hover:text-gray-600"><svg
                            class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="p-8 overflow-y-auto custom-scrollbar space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Nombre de la Tarea</label>
                        <input type="text" id="tarea-name"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all outline-none"
                            placeholder="Ej: Tarea #1 - Geometría">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-slate-700">Fechas de Evaluación</label>
                            <button onclick="app.addTareaDate()"
                                class="text-xs font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-1 rounded-lg">+
                                Fecha</button>
                        </div>
                        <div id="tarea-dates-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-slate-700">Habilidades e Indicadores</label>
                            <button onclick="app.addTareaSkill()"
                                class="text-xs font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-1 rounded-lg">+
                                Habilidad</button>
                        </div>
                        <div id="tarea-skills-container" class="space-y-4"></div>
                    </div>
                </div>
                <div class="px-8 py-6 bg-gray-50 flex justify-between items-center border-t border-gray-100">
                    <button id="btn-delete-tarea" onclick="app.deleteTarea(currentEditingTareaId)"
                        class="text-red-500 font-bold text-sm hover:bg-red-50 px-4 py-2 rounded-xl transition-colors hidden">Eliminar</button>
                    <div class="flex gap-3">
                        <button onclick="app.closeTareaEditor()"
                            class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-white hover:text-slate-700 transition-colors">Cancelar</button>
                        <button onclick="app.saveTarea()"
                            class="px-6 py-2.5 rounded-xl bg-purple-600 text-white font-bold shadow-lg shadow-purple-500/20 hover:bg-purple-700 transition-all active:scale-95">Guardar
                            Tarea</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Editor Modal (Hidden) -->
        <div id="activity-editor"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-xl font-bold text-slate-800">Editar Actividad</h3>
                    <button onclick="app.closeActivityEditor()" class="text-gray-400 hover:text-gray-600"><svg
                            class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="p-8 overflow-y-auto space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Nombre de la Actividad</label>
                        <input type="text" id="act-name"
                            class="w-full px-4 py-3 bg-gray-50 border-0 rounded-xl font-medium focus:ring-2 focus:ring-blue-500/20"
                            placeholder="Ej: Práctica de Geometría">
                    </div>

                    <!-- Dates -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-700">Fechas de Evaluación</label>
                            <button onclick="app.addActivityDate()"
                                class="text-xs font-bold text-blue-600 hover:bg-blue-50 px-2 py-1 rounded">+ Agregar
                                Fecha</button>
                        </div>
                        <div id="act-dates-list" class="space-y-2"></div>
                    </div>

                    <!-- Skills -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-700">Indicadores / Aprendizajes</label>
                            <button onclick="app.addActivitySkill()"
                                class="text-xs font-bold text-blue-600 hover:bg-blue-50 px-2 py-1 rounded">+ Agregar
                                Indicador</button>
                        </div>
                        <div id="act-skills-list" class="space-y-4"></div>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                    <button onclick="app.deleteActivity(currentEditingActivityId)" id="btn-delete-activity"
                        class="text-red-500 font-bold px-4 py-2 hover:bg-red-50 rounded-xl hidden">Eliminar</button>
                    <button onclick="app.saveActivity()"
                        class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-700 shadow-lg shadow-slate-800/20">Guardar
                        Cambios</button>
                </div>
            </div>
        </div>

        <!-- Evaluator View (Hidden by default) -->
        <div id="evaluator-view" class="hidden fixed inset-0 bg-white z-50 overflow-hidden flex flex-col">
            <div
                class="bg-white border-b border-gray-200 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 shadow-sm z-20 relative">
                <div class="flex-1 min-w-0">
                    <button onclick="app.closeEvaluator()"
                        class="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver a Actividades
                    </button>
                    <h2 class="text-xl font-bold text-slate-800 truncate" id="eval-title">Calificando: ...</h2>
                </div>
                <div class="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto">
                    <div
                        class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-xl border border-blue-100 flex-1 sm:flex-none justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <select id="eval-date-selector"
                            class="text-sm font-bold text-blue-700 bg-transparent border-0 cursor-pointer focus:ring-0 p-0 w-full sm:w-auto">
                            <!-- Dates populated by JS -->
                        </select>
                    </div>
                    <span id="save-status"
                        class="text-green-600 text-xs font-bold uppercase opacity-0 transition-opacity duration-300">Guardado</span>
                    <button onclick="app.closeEvaluator()"
                        class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-xl font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors border border-gray-200 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <span class="hidden sm:inline">Salir</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-auto bg-gray-50 p-6" id="evaluator-grid-container">
                <!-- Dynamic Grid Wrapper -->
            </div>
        </div>
        </section>

        <!-- VIEW: COTIDIANO SUMMARY REPORT -->
        <section id="cotidiano-summary-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('cotidiano-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver a Cotidiano
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Reporte General: Trabajo Cotidiano
                    </h2>
                </div>
                <div class="bg-blue-50 text-blue-800 px-4 py-2 rounded-xl text-sm font-bold border border-blue-100">
                    <span id="cs-level-badge">Nivel X</span> - Periodo <span id="cs-period-badge">X</span>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-50 p-6 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100 border border-gray-100 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr id="cs-table-header"></tr>
                        </thead>
                        <tbody id="cs-table-body" class="bg-white divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        </section>

        <!-- VIEW: TAREAS SUMMARY REPORT -->
        <section id="tareas-summary-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('tareas-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver a Tareas
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Reporte General: Tareas
                    </h2>
                </div>
                <div
                    class="bg-purple-50 text-purple-800 px-4 py-2 rounded-xl text-sm font-bold border border-purple-100">
                    <span id="ts-level-badge">Nivel X</span> - Periodo <span id="ts-period-badge">X</span>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-50 p-6 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100 border border-gray-100 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr id="ts-table-header"></tr>
                        </thead>
                        <tbody id="ts-table-body" class="bg-white divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: PRUEBAS SUMMARY REPORT -->
        <section id="pruebas-summary-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('pruebas-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver a Pruebas
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Reporte General: Pruebas</h2>
                </div>
                <div
                    class="bg-indigo-50 text-indigo-800 px-4 py-2 rounded-xl text-sm font-bold border border-indigo-100">
                    <span id="ps-level-badge">Nivel X</span> - Periodo <span id="ps-period-badge">X</span>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-50 p-6 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100 border border-gray-100 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr id="ps-table-header"></tr>
                        </thead>
                        <tbody id="ps-table-body" class="bg-white divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: PRUEBAS (Exams) -->
        <section id="pruebas-view" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <button onclick="app.navigateTo('dashboard-view')"
                        class="text-sm text-slate-500 hover:text-brand-600 flex items-center gap-1 mb-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver al Dashboard
                    </button>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Pruebas</h2>
                    <p class="text-slate-500 mt-1">Gestión de Exámenes y Adecuaciones.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.navigateTo('pruebas-summary-view')"
                        class="bg-white text-indigo-600 border border-indigo-200 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-indigo-50 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Ver Reporte
                    </button>
                    <button onclick="app.openPruebasEditor()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nueva Prueba
                    </button>
                </div>
            </div>
            <div id="pruebas-activities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Pruebas Editor Modal -->
        <div id="pruebas-editor"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col animate-scale-in">
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-xl font-bold text-slate-800">Editar Prueba</h3>
                    <button onclick="app.closePruebasEditor()" class="text-gray-400 hover:text-gray-600"><svg
                            class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="p-8 space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Nombre de la Prueba</label>
                        <input type="text" id="prueba-name"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none"
                            placeholder="Ej: I Parcial - Funciones">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Fecha de Aplicación</label>
                        <input type="date" id="prueba-date"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Valor Puntos</label>
                            <input type="number" id="prueba-points" min="1"
                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none"
                                placeholder="Ej: 50">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Valor Porcentual (%)</label>
                            <input type="number" id="prueba-percentage" min="1" max="100"
                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none"
                                placeholder="Ej: 15">
                        </div>
                    </div>
                </div>
                <div class="px-8 py-6 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                    <button onclick="app.deletePrueba(currentEditingPruebaId)" id="btn-delete-prueba"
                        class="text-red-500 font-bold px-4 py-2 hover:bg-red-50 rounded-xl hidden">Eliminar</button>
                    <button onclick="app.savePrueba()"
                        class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-700 shadow-lg shadow-slate-800/20">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Pruebas Evaluator Overlay (Reuse pattern) -->
        <div id="pruebas-evaluator-view" class="hidden fixed inset-0 bg-white z-50 overflow-hidden flex flex-col">
            <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm z-20">
                <div>
                    <button onclick="app.closePruebasEvaluator()"
                        class="text-sm text-gray-500 hover:text-indigo-600 flex items-center gap-1 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Volver a Pruebas
                    </button>
                    <h2 class="text-xl font-bold text-slate-800 truncate" id="pruebas-eval-title">Calificando: ...</h2>
                </div>
                <div class="flex items-center gap-3">
                    <span id="pruebas-save-status"
                        class="text-green-600 text-xs font-bold uppercase opacity-0 transition-opacity duration-300">Guardado</span>
                    <button onclick="app.closePruebasEvaluator()"
                        class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-xl font-bold hover:bg-red-50 hover:text-red-600 transition-colors border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Salir
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-auto bg-gray-50 p-6" id="pruebas-evaluator-grid">
                <!-- Grid/Table content -->
            </div>
        </div>

        <!-- GENERIC RUBRIC (Placeholder) -->
        <section id="rubric-view-container" class="view-section hidden-view animate-fade-in">
            <div class="flex items-center justify-between mb-8">
                <h2 id="rubric-title" class="text-3xl font-extrabold text-slate-800 tracking-tight">Rubro</h2>
                <button onclick="app.navigateTo('dashboard-view')"
                    class="flex items-center bg-white border border-gray-200 text-gray-600 hover:text-brand-600 px-5 py-2.5 rounded-xl transition-all shadow-sm font-medium">Volver</button>
            </div>
            <div class="bg-white p-16 rounded-3xl text-center border-2 border-dashed border-gray-200">
                <h3 class="text-xl font-bold text-slate-800 mb-2">Vista en Construcción</h3>
                <p id="rubric-view-name"
                    class="font-mono text-xs text-gray-400 bg-gray-100 inline-block px-3 py-1 rounded-full"></p>
            </div>
        </section>

    </main>

    <!-- CORE LOGIC START -->
    <script>
        const app = (() => {
            const state = { currentLevel: '7', currentPeriod: 1, students: {}, attendance: {}, cotidiano: {} };
            const CONSTANTS = {
                COLORS: { P1: { hex: '#2563eb' }, P2: { hex: '#10b981' } },
                PERCENTAGES: { LOWER: { cotidiano: 45, tareas: 10, pruebas: 40, asistencia: 5 }, UPPER: { cotidiano: 35, tareas: 10, pruebas: 50, asistencia: 5 } }
            };

            const els = {
                levelSelector: document.getElementById('level-selector'),
                period1Btn: document.getElementById('period-1-btn'), period2Btn: document.getElementById('period-2-btn'),
                percentCotidiano: document.getElementById('percent-cotidiano'), percentPruebas: document.getElementById('percent-pruebas'),
                sections: document.querySelectorAll('.view-section'), studentSearch: document.getElementById('student-search'),
                searchResults: document.getElementById('search-results'), csvUpload: document.getElementById('csv-upload'),
                configStudentList: document.getElementById('config-student-list'), newStudentId: document.getElementById('new-student-id'),
                newStudentName: document.getElementById('new-student-name'), rubricTitle: document.getElementById('rubric-title'),
                rubricViewName: document.getElementById('rubric-view-name'), rubricContainer: document.getElementById('rubric-view-container'),
                stdName: document.getElementById('std-name'), stdId: document.getElementById('std-id'), stdLevel: document.getElementById('std-level'),
                stdGradeCotidiano: document.getElementById('std-grade-cotidiano'), stdBarCotidiano: document.getElementById('std-bar-cotidiano'),
                stdGradeTareas: document.getElementById('std-grade-tareas'), stdBarTareas: document.getElementById('std-bar-tareas'),
                stdGradePruebas: document.getElementById('std-grade-pruebas'), stdBarPruebas: document.getElementById('std-bar-pruebas'),
                stdGradeAsistencia: document.getElementById('std-grade-asistencia'), stdBarAsistencia: document.getElementById('std-bar-asistencia'),
            };

            function init() { loadData(); setupEventListeners(); if (els.studentSearch) els.studentSearch.value = ''; renderUI(); }
            function loadData() {
                const stored = localStorage.getItem('academicApp_2026_data');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    state.students = parsed.students || {};
                    state.attendance = parsed.attendance || {};
                    state.cotidiano = parsed.cotidiano || {};
                    state.tareas = parsed.tareas || {};
                    state.pruebas = parsed.pruebas || {};
                } else {
                    ['7', '8', '9', '10', '11'].forEach(l => { if (!state.students[l]) state.students[l] = []; });
                }
            }
            function saveData() {
                localStorage.setItem('academicApp_2026_data', JSON.stringify({ students: state.students, attendance: state.attendance || {}, cotidiano: state.cotidiano || {}, tareas: state.tareas || {}, pruebas: state.pruebas || {} }));
            }

            function navigateTo(viewId, metadata = {}) {
                els.sections.forEach(s => s.classList.add('hidden-view'));
                if (viewId === 'student-view') {
                    loadStudentView(metadata.student); document.getElementById('student-view').classList.remove('hidden-view');
                } else if (viewId.includes('-view') && document.getElementById(viewId)) {
                    document.getElementById(viewId).classList.remove('hidden-view');
                } else if (viewId === 'rubric-view') { els.rubricContainer.classList.remove('hidden-view'); }

                if (viewId === 'cotidiano-view') { renderCotidianoPanel(); }
                else if (viewId === 'tareas-view') { renderTareasPanel(); }
                else if (viewId === 'pruebas-view') { renderPruebasPanel(); }
                else if (viewId === 'asistencia-view') {
                    if (!state.attendance) state.attendance = {};
                    const today = new Date().toISOString().split('T')[0];
                    if (document.getElementById('att-date') && !document.getElementById('att-date').value) document.getElementById('att-date').value = today;
                    renderAttendanceView(); document.getElementById('asistencia-view').classList.remove('hidden-view');
                } else if (viewId === 'asistencia-summary-view') {
                    renderAttendanceSummary(); document.getElementById('asistencia-summary-view').classList.remove('hidden-view');
                } else if (viewId === 'cotidiano-summary-view') {
                    renderCotidianoSummaryReport(); document.getElementById('cotidiano-summary-view').classList.remove('hidden-view');
                } else if (viewId === 'tareas-summary-view') {
                    renderTareasSummaryReport(); document.getElementById('tareas-summary-view').classList.remove('hidden-view');
                } else if (viewId === 'pruebas-summary-view') {
                    renderPruebasSummaryReport(); document.getElementById('pruebas-summary-view').classList.remove('hidden-view');
                }

                if (viewId === 'config-view') renderConfigStudentList();
            }



            // ATTENDANCE LOGIC (Simple Restoration)
            function renderAttendanceView() {
                // Placeholder to prevent crash
                const list = document.getElementById('attendance-list');
                if (list) list.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">Funcionalidad de Asistencia en restauración...</td></tr>';
            }
            function renderAttendanceSummary() { }
            function setAttStatus() { }
            function updateAttLessonCount() { }
            function deleteAttendanceDate() { }

            // ACTIVITY EDITOR (Placeholder)
            function openActivityEditor() { }
            function closeActivityEditor() { }
            function saveActivity() { }
            function deleteActivity() { }
            function addActivityDate() { }
            function addActivitySkill() { }
            function addIndicator() { }
            function renderCotidianoSummaryReport() { }


            // PRUEBAS LOGIC - NEW IMPLEMENTATION
            let currentEditingPruebaId = null;
            let currentPruebaEvalId = null;

            function renderPruebasPanel() {
                if (!state.pruebas[state.currentLevel]) state.pruebas[state.currentLevel] = {};
                if (!state.pruebas[state.currentLevel][state.currentPeriod]) state.pruebas[state.currentLevel][state.currentPeriod] = { activities: [], grades: {}, overrides: {} };

                const list = document.getElementById('pruebas-activities-list');
                const acts = state.pruebas[state.currentLevel][state.currentPeriod].activities || [];

                list.innerHTML = acts.map(act => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-lg transition-all group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                             <button onclick="app.openPruebasEditor('${act.id}')" class="p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100" title="Editar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                             <button onclick="app.deletePrueba('${act.id}')" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100" title="Eliminar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2 truncate pr-20">${act.name}</h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                             <span class="px-2 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-lg">${act.date}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500 mb-4 border-t border-gray-50 pt-2">
                            <span>Valor: <b>${act.points} pts</b></span>
                            <span>Porcentaje: <b>${act.percentage}%</b></span>
                        </div>
                        <button onclick="app.openPruebasEvaluator('${act.id}')" class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold text-sm hover:bg-slate-700 shadow-lg shadow-slate-800/10 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Calificar
                        </button>
                    </div>
                `).join('');
            }

            function openPruebasEditor(actId) {
                currentEditingPruebaId = actId;
                const editor = document.getElementById('pruebas-editor');
                const isEdit = !!actId;

                editor.querySelector('h3').innerText = isEdit ? 'Editar Prueba' : 'Nueva Prueba';
                const delBtn = document.getElementById('btn-delete-prueba');
                if (delBtn) delBtn.style.display = isEdit ? 'block' : 'none';

                if (isEdit) {
                    const act = state.pruebas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);
                    if (act) {
                        document.getElementById('prueba-name').value = act.name;
                        document.getElementById('prueba-date').value = act.date;
                        document.getElementById('prueba-points').value = act.points;
                        document.getElementById('prueba-percentage').value = act.percentage;
                    }
                } else {
                    document.getElementById('prueba-name').value = '';
                    document.getElementById('prueba-date').value = '';
                    document.getElementById('prueba-points').value = '';
                    document.getElementById('prueba-percentage').value = '';
                }

                editor.classList.remove('hidden');
            }

            function closePruebasEditor() {
                document.getElementById('pruebas-editor').classList.add('hidden');
                currentEditingPruebaId = null;
            }

            function savePrueba() {
                console.log("Saving prueba...");
                const name = document.getElementById('prueba-name').value;
                const date = document.getElementById('prueba-date').value;
                const points = parseFloat(document.getElementById('prueba-points').value);
                const percentage = parseFloat(document.getElementById('prueba-percentage').value);

                if (!name || isNaN(points) || isNaN(percentage)) return alert('Por favor complete todos los campos correctamente.');

                // Validation: Total Percentage
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                const existingActs = periodData.activities || [];

                let currentTotal = 0;
                existingActs.forEach(a => {
                    if (currentEditingPruebaId && a.id === currentEditingPruebaId) return; // Skip current if editing
                    currentTotal += parseFloat(a.percentage);
                });

                const maxPercentage = ['10', '11'].includes(state.currentLevel) ? 50 : 40; // Logic from CONSTANTS
                if (currentTotal + percentage > maxPercentage) {
                    return alert(`No puedes exceder el porcentaje total de Pruebas (${maxPercentage}%). Actual: ${currentTotal}%, Nuevo: ${percentage}%, Total: ${currentTotal + percentage}%`);
                }

                if (!periodData.activities) periodData.activities = [];

                if (currentEditingPruebaId) {
                    const act = periodData.activities.find(a => a.id === currentEditingPruebaId);
                    if (act) {
                        act.name = name;
                        act.date = date;
                        act.points = points;
                        act.percentage = percentage;
                    }
                } else {
                    const newAct = {
                        id: crypto.randomUUID(),
                        name,
                        date,
                        points,
                        percentage
                    };
                    periodData.activities.push(newAct);
                }

                saveData();
                closePruebasEditor();
                renderPruebasPanel();
            }

            function deletePrueba(actId) {
                if (!confirm('¿Estás seguro de eliminar esta prueba? Se perderán las calificaciones asociadas.')) return;

                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                periodData.activities = periodData.activities.filter(a => a.id !== actId);
                if (periodData.grades && periodData.grades[actId]) delete periodData.grades[actId];

                // Note: Not explicitly deleting overrides to avoid complexity, they will just be orphaned which is fine for now.

                saveData();
                closePruebasEditor();
                renderPruebasPanel();
            }

            function openPruebasEvaluator(actId) {
                currentPruebaEvalId = actId;
                const act = state.pruebas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);
                if (!act) return;

                document.getElementById('pruebas-eval-title').innerText = `Calificando: ${act.name}`;
                document.getElementById('pruebas-evaluator-view').classList.remove('hidden');
                renderPruebasEvaluatorGrid();
            }

            function closePruebasEvaluator() {
                document.getElementById('pruebas-evaluator-view').classList.add('hidden');
                currentPruebaEvalId = null;
                renderPruebasPanel(); // Refresh summary if needed
            }

            function renderPruebasEvaluatorGrid() {
                const container = document.getElementById('pruebas-evaluator-grid');
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                const act = periodData.activities.find(a => a.id === currentPruebaEvalId);
                const students = state.students[state.currentLevel] || [];
                const grades = periodData.grades && periodData.grades[act.id] ? periodData.grades[act.id] : {};

                if (!periodData.overrides) periodData.overrides = {};

                let html = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="px-6 py-3 text-left sticky left-0 bg-gray-50 z-10 w-48">Estudiante</th>
                                    <th class="px-2 py-3 text-center w-32">Fecha</th>
                                    <th class="px-2 py-3 text-center w-24" title="Adecuación Significativa">Adecuación</th>
                                    <th class="px-2 py-3 text-center w-20">Valor</th>
                                    <th class="px-2 py-3 text-center w-20">%</th>
                                    <th class="px-4 py-3 text-center w-24">Obtenido</th>
                                    <th class="px-4 py-3 text-center">Nota</th>
                                    <th class="px-4 py-3 text-center">% Final</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                 `;

                html += students.map(std => {
                    const stdOverrides = periodData.overrides[std.id] && periodData.overrides[std.id][act.id]
                        ? periodData.overrides[std.id][act.id]
                        : { isAS: false };

                    const isAS = stdOverrides.isAS;
                    const date = stdOverrides.date || act.date || '';
                    const totalPts = (isAS && stdOverrides.points) ? stdOverrides.points : act.points;
                    const percentage = (isAS && stdOverrides.percentage) ? stdOverrides.percentage : act.percentage;

                    const score = grades[std.id] !== undefined ? grades[std.id] : '';

                    let grade = 0;
                    let earnedPct = 0;
                    if (score !== '' && totalPts > 0) {
                        grade = (parseFloat(score) / totalPts) * 100;
                        earnedPct = (parseFloat(score) / totalPts) * percentage;
                    }

                    const gradeClass = grade >= 65 ? 'text-green-600' : 'text-red-500';

                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-3 font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-50">${std.name}</td>
                            <td class="px-2 py-3 text-center">
                                <input type="date" value="${date}" onchange="app.setPruebaOverride('${std.id}', 'date', this.value)" 
                                    class="w-full border border-gray-200 rounded px-1 py-1 text-xs text-center focus:border-indigo-500 outline-none">
                            </td>
                            <td class="px-2 py-3 text-center">
                                <button onclick="app.togglePruebaAS('${std.id}')" 
                                    class="px-3 py-1 rounded-full text-[10px] font-bold border transition-all ${isAS ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-gray-50 text-gray-300 border-gray-200 hover:bg-gray-100'}">
                                    ${isAS ? 'SI' : 'NO'}
                                </button>
                            </td>
                            <td class="px-2 py-3 text-center">
                                <input type="number" value="${totalPts}" ${isAS ? '' : 'disabled'} 
                                    onchange="app.setPruebaOverride('${std.id}', 'points', this.value)"
                                    class="w-16 text-center border border-gray-200 rounded px-1 py-1 text-xs focus:border-indigo-500 outline-none ${isAS ? 'bg-white font-bold text-indigo-700 border-indigo-200' : 'bg-transparent text-gray-400 border-transparent'}">
                            </td>
                            <td class="px-2 py-3 text-center">
                                <input type="number" value="${percentage}" ${isAS ? '' : 'disabled'}
                                    onchange="app.setPruebaOverride('${std.id}', 'percentage', this.value)"
                                    class="w-14 text-center border border-gray-200 rounded px-1 py-1 text-xs focus:border-indigo-500 outline-none ${isAS ? 'bg-white font-bold text-indigo-700 border-indigo-200' : 'bg-transparent text-gray-400 border-transparent'}">
                            </td>
                            <td class="px-4 py-3 text-center">
                                <input type="number" value="${score}" 
                                    onchange="app.setPruebaScore('${std.id}', this.value)"
                                    class="w-20 text-center border border-gray-200 rounded px-2 py-1 text-sm font-bold text-slate-800 focus:border-indigo-500 outline-none focus:ring-2 focus:ring-indigo-500/20">
                            </td>
                            <td class="px-4 py-3 text-center font-bold text-sm ${gradeClass}">
                                ${score !== '' ? grade.toFixed(0) : '-'}
                            </td>
                            <td class="px-4 py-3 text-center font-bold text-slate-700">
                                ${score !== '' ? earnedPct.toFixed(1) + '%' : '-'}
                            </td>
                        </tr>
                     `;
                }).join('');

                html += `</tbody></table></div></div>`;
                container.innerHTML = html;
            }

            function setPruebaScore(stdId, val) {
                if (!currentPruebaEvalId) return;
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];

                // Get specifics for validation
                const act = periodData.activities.find(a => a.id === currentPruebaEvalId);
                const overrides = periodData.overrides && periodData.overrides[stdId] && periodData.overrides[stdId][currentPruebaEvalId]
                    ? periodData.overrides[stdId][currentPruebaEvalId] : {};

                const isAS = overrides.isAS;
                const maxPts = (isAS && overrides.points) ? parseFloat(overrides.points) : parseFloat(act.points);

                if (val !== '' && parseFloat(val) > maxPts) {
                    alert(`El puntaje (${val}) no puede ser mayor al valor de la prueba (${maxPts}).`);
                    renderPruebasEvaluatorGrid();
                    return;
                }

                if (!periodData.grades[currentPruebaEvalId]) periodData.grades[currentPruebaEvalId] = {};
                const actGrades = periodData.grades[currentPruebaEvalId];

                if (val === '') delete actGrades[stdId];
                else actGrades[stdId] = parseFloat(val);

                saveData();
                renderPruebasEvaluatorGrid();

                const el = document.getElementById('pruebas-save-status');
                if (el) { el.classList.remove('opacity-0'); setTimeout(() => el.classList.add('opacity-0'), 1000); }
            }

            function togglePruebaAS(stdId) {
                if (!currentPruebaEvalId) return;
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                if (!periodData.overrides) periodData.overrides = {};
                if (!periodData.overrides[stdId]) periodData.overrides[stdId] = {};
                if (!periodData.overrides[stdId][currentPruebaEvalId]) periodData.overrides[stdId][currentPruebaEvalId] = {};

                // Initialize if empty
                if (periodData.overrides[stdId][currentPruebaEvalId].isAS === undefined) {
                    periodData.overrides[stdId][currentPruebaEvalId].isAS = false;
                }

                const current = periodData.overrides[stdId][currentPruebaEvalId].isAS;
                periodData.overrides[stdId][currentPruebaEvalId].isAS = !current;

                saveData();
                renderPruebasEvaluatorGrid();
            }

            function setPruebaOverride(stdId, field, val) {
                if (!currentPruebaEvalId) return;
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                if (!periodData.overrides) periodData.overrides = {};
                if (!periodData.overrides[stdId]) periodData.overrides[stdId] = {};
                if (!periodData.overrides[stdId][currentPruebaEvalId]) periodData.overrides[stdId][currentPruebaEvalId] = {};

                let value = val;
                if (field === 'points' || field === 'percentage') value = parseFloat(val);

                periodData.overrides[stdId][currentPruebaEvalId][field] = value;
                saveData();
                renderPruebasEvaluatorGrid();
            }

            function calculatePruebasMetrics(stdId) {
                if (!state.pruebas[state.currentLevel] || !state.pruebas[state.currentLevel][state.currentPeriod]) {
                    return { percentage: 0, details: [] };
                }
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};
                const overrides = periodData.overrides || {};

                let totalPercentage = 0;

                const details = activities.map(act => {
                    const stdOverrides = overrides[stdId] && overrides[stdId][act.id] ? overrides[stdId][act.id] : {};
                    const isAS = stdOverrides.isAS;

                    // DEBUG: Explicit check for act.points
                    if (act.points === undefined || act.points === "" || isNaN(parseFloat(act.points))) {
                        console.warn(`[DEBUG] Invalid act.points for ${act.name}:`, act.points);
                    }

                    // Safe parsing for max points
                    let maxPts = (isAS && stdOverrides.points !== undefined && stdOverrides.points !== "")
                        ? parseFloat(stdOverrides.points)
                        : parseFloat(act.points);

                    if (isNaN(maxPts) || maxPts <= 0) maxPts = 0;

                    // Safe parsing for percentage
                    let weightPct = (isAS && stdOverrides.percentage !== undefined && stdOverrides.percentage !== "")
                        ? parseFloat(stdOverrides.percentage)
                        : parseFloat(act.percentage);

                    if (isNaN(weightPct) || weightPct < 0) weightPct = 0;

                    // DEBUG: Warn if returning 0 maxPts
                    if (maxPts === 0 && act.points) {
                        console.warn(`[DEBUG] MaxPts became 0 for ${stdId}, Act: ${act.name}`, { act, stdOverrides, parsed: parseFloat(act.points) });
                    }

                    const actGrades = grades[act.id] || {};
                    const val = actGrades[stdId];

                    if (val !== undefined && val !== '' && !isNaN(val)) {
                        const score = parseFloat(val);
                        let earned = 0;
                        if (maxPts > 0) earned = (score / maxPts) * weightPct;

                        if (!isNaN(earned)) totalPercentage += earned;

                        return { name: act.name, earned: earned || 0, weight: weightPct, score: score, max: maxPts || 0 };
                    }
                    // Explicit fallback
                    return { name: act.name, earned: 0, weight: weightPct, score: 0, max: maxPts || 0, missing: true };
                });

                return { percentage: totalPercentage || 0, details };
            }

            function calculatePruebasMetricsV2(stdId, period = state.currentPeriod) {
                if (!state.pruebas[state.currentLevel] || !state.pruebas[state.currentLevel][period]) {
                    return { percentage: 0, details: [] };
                }
                const periodData = state.pruebas[state.currentLevel][period];
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};
                const overrides = periodData.overrides || {};

                let totalPercentage = 0;

                const details = activities.map(act => {
                    const stdOverrides = overrides[stdId] && overrides[stdId][act.id] ? overrides[stdId][act.id] : {};
                    const isAS = stdOverrides.isAS;

                    // Safe parsing for max points
                    let maxPts = (isAS && stdOverrides.points !== undefined && stdOverrides.points !== "")
                        ? parseFloat(stdOverrides.points)
                        : parseFloat(act.points);

                    // FORCE NUMBER PARANOID
                    if (typeof maxPts !== 'number' || isNaN(maxPts) || maxPts <= 0) {
                        maxPts = 0;
                    }

                    // Safe parsing for percentage
                    let weightPct = (isAS && stdOverrides.percentage !== undefined && stdOverrides.percentage !== "")
                        ? parseFloat(stdOverrides.percentage)
                        : parseFloat(act.percentage);

                    // FORCE NUMBER PARANOID
                    if (typeof weightPct !== 'number' || isNaN(weightPct) || weightPct < 0) {
                        weightPct = 0;
                    }

                    const actGrades = grades[act.id] || {};
                    const val = actGrades[stdId];

                    if (val !== undefined && val !== '' && !isNaN(val)) {
                        const score = parseFloat(val);
                        let earned = 0;
                        if (maxPts > 0) earned = (score / maxPts) * weightPct;

                        if (!isNaN(earned)) totalPercentage += earned;

                        return {
                            name: act.name,
                            earned: (typeof earned === 'number' && !isNaN(earned)) ? earned : 0,
                            weight: weightPct,
                            score: score,
                            max: maxPts // Guaranteed to be a number 0+
                        };
                    }
                    // Explicit fallback
                    return {
                        name: act.name,
                        earned: 0,
                        weight: weightPct,
                        score: 0,
                        max: maxPts, // Guaranteed to be a number 0+
                        missing: true
                    };
                });

                return { percentage: totalPercentage || 0, details };
            }

            function renderPruebasSummaryReport() {
                const levelData = state.pruebas[state.currentLevel] || {};
                const periodData = levelData[state.currentPeriod] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const students = state.students[state.currentLevel] || [];

                // Set Header info
                if (document.getElementById('ps-level-badge')) document.getElementById('ps-level-badge').innerText = `Nivel ${state.currentLevel}`;
                if (document.getElementById('ps-period-badge')) document.getElementById('ps-period-badge').innerText = state.currentPeriod;

                const headerRow = document.getElementById('ps-table-header');
                const body = document.getElementById('ps-table-body');

                if (!headerRow || !body) return;

                // 1. Build Header
                let headersHTML = `<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 border-r border-gray-200">Estudiante</th>`;

                activities.forEach(act => {
                    headersHTML += `<th class="px-2 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider border-r border-gray-100 min-w-[140px] bg-gray-50">
                        <div class="truncate w-full" title="${act.name}">${act.name}</div>
                    </th>`;
                });

                headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-brand-600 uppercase tracking-wider bg-blue-50 border-l border-blue-100">Total %</th>`;

                headerRow.innerHTML = headersHTML;

                // 2. Build Rows
                body.innerHTML = students.map(s => {
                    const metrics = calculatePruebasMetricsV2(s.id);

                    const cellsHTML = metrics.details.map(d => {
                        if (d.missing) return `<td class="px-2 py-3 text-center text-xs text-gray-400 border-r border-gray-50 bg-gray-50/50">-</td>`;

                        // VISUAL DEBUGGING
                        if (isNaN(d.max) || d.max === undefined || d.max === null) {
                            return `<td class="px-2 py-3 text-center text-xs border-r border-gray-50 bg-red-50 text-red-600 font-bold">
                                ERR: Max=${d.max}
                             </td>`;
                        }

                        return `<td class="px-2 py-3 text-center text-xs border-r border-gray-50">
                            <div class="flex flex-row gap-2 items-center justify-center p-1">
                                <span class="font-bold text-slate-700 bg-slate-100 px-2 py-0.5 rounded text-[10px]" title="Puntos">${d.score}</span>
                                <span class="text-gray-300">|</span>
                                <span class="text-[10px] text-gray-500" title="Nota">${d.max > 0 ? ((d.score / d.max) * 100).toFixed(0) : '0'}</span>
                                <span class="text-gray-300">|</span>
                                <span class="font-bold text-indigo-600 text-[10px]" title="Porcentaje">${d.earned.toFixed(1)}%</span>
                            </div>
                         </td>`;
                    }).join('');

                    return `
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0 h-14">
                            <td class="px-4 py-3 text-sm font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-100 shadow-sm z-20">${s.name}</td>
                            ${cellsHTML}
                            <td class="px-4 py-3 text-center font-extrabold text-indigo-700 bg-indigo-50/20 border-l border-indigo-50">${metrics.percentage.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');
            }



















            // TAREAS LOGIC
            let currentEditingTareaId = null;

            function renderTareasPanel() {
                if (!state.tareas[state.currentLevel]) state.tareas[state.currentLevel] = {};
                if (!state.tareas[state.currentLevel][state.currentPeriod]) state.tareas[state.currentLevel][state.currentPeriod] = { activities: [], grades: {} };

                const list = document.getElementById('tareas-activities-list');
                const acts = state.tareas[state.currentLevel][state.currentPeriod].activities;

                // Panel Header with Report Button

                list.innerHTML = acts.map(act => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-lg transition-all group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                             <button onclick="app.openTareaEditor('${act.id}')" class="p-2 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100" title="Editar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                             <button onclick="app.deleteTarea('${act.id}')" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100" title="Eliminar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2 truncate pr-20">${act.name}</h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${act.dates.map(d => `<span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs font-bold rounded-lg">${d}</span>`).join('')}
                        </div>
                        <div class="space-y-1 mb-4">
                             ${act.skills.map(s => `<div class="text-xs text-gray-500 truncate flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gray-300"></span>${s.name} (${s.indicators.length} ind)</div>`).join('')}
                        </div>
                        <button onclick="window.app.openTareaEvaluator('${act.id}')" class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold text-sm hover:bg-slate-700 shadow-lg shadow-slate-800/10 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Calificar Tarea
                        </button>
                    </div>
                `).join('');
            }

            function openTareaEditor(tareaId) {
                currentEditingTareaId = tareaId;
                const editor = document.getElementById('tarea-editor');
                const isEdit = !!tareaId;

                editor.querySelector('h3').innerText = isEdit ? 'Editar Tarea' : 'Nueva Tarea';
                const delBtn = document.getElementById('btn-delete-tarea');
                if (delBtn) delBtn.style.display = isEdit ? 'block' : 'none';

                if (isEdit) {
                    const act = state.tareas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === tareaId);
                    if (act) {
                        document.getElementById('tarea-name').value = act.name;
                        const dateCont = document.getElementById('tarea-dates-container');
                        dateCont.innerHTML = '';
                        act.dates.forEach(d => {
                            const wrapper = document.createElement('div'); wrapper.className = 'flex items-center gap-1 mb-2';
                            wrapper.innerHTML = `<input type="date" value="${d}" class="border border-gray-200 rounded-lg px-2 py-1 text-sm"><button onclick="app.deleteTareaDate(this)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
                            dateCont.appendChild(wrapper);
                        });

                        const skillCont = document.getElementById('tarea-skills-container');
                        skillCont.innerHTML = '';
                        act.skills.forEach(s => {
                            const sDiv = document.createElement('div');
                            sDiv.className = 'bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 border border-purple-100 relative group shadow-sm';

                            let indicatorsHTML = s.indicators.map(indData => {
                                const inicial = indData.levels?.inicial || '';
                                const intermedio = indData.levels?.intermedio || '';
                                const avanzado = indData.levels?.avanzado || '';
                                const points = indData.max || 0;
                                const pointsClass = points === 0 ? 'bg-gray-100 text-gray-700' :
                                    points === 1 ? 'bg-yellow-100 text-yellow-700' :
                                        points === 2 ? 'bg-blue-100 text-blue-700' :
                                            'bg-green-100 text-green-700';

                                return `
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-3 py-2">
                                        <textarea class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 resize-none overflow-hidden font-medium" 
                                            placeholder="Nombre del indicador" 
                                            rows="1"
                                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px';">${indData.name}</textarea>
                                    </td>
                                    <td class="px-3 py-2">
                                        <textarea class="w-full border border-yellow-200 bg-yellow-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 resize-none overflow-hidden rubric-textarea" 
                                            placeholder="Describe el nivel básico..." 
                                            rows="2"
                                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);">${inicial}</textarea>
                                    </td>
                                    <td class="px-3 py-2">
                                        <textarea class="w-full border border-blue-200 bg-blue-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 resize-none overflow-hidden rubric-textarea" 
                                            placeholder="Describe el nivel medio..." 
                                            rows="2"
                                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);">${intermedio}</textarea>
                                    </td>
                                    <td class="px-3 py-2">
                                        <textarea class="w-full border border-green-200 bg-green-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20 resize-none overflow-hidden rubric-textarea" 
                                            placeholder="Describe el nivel avanzado..." 
                                            rows="2"
                                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);">${avanzado}</textarea>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <span class="indicator-points-display inline-block ${pointsClass} font-bold text-sm px-2 py-1 rounded-lg min-w-[2rem]">${points}</span>
                                    </td>
                                    <td class="px-2 py-2 text-center">
                                        <button onclick="app.deleteTareaIndicator(this)" class="text-gray-400 hover:text-red-500 transition-colors">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                `;
                            }).join('');

                            sDiv.innerHTML = `
                                <button onclick="app.deleteTareaSkill(this)" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                <input type="text" value="${s.name}" class="w-full font-bold bg-white/70 border-2 border-transparent focus:border-purple-400 outline-none text-slate-800 mb-4 px-3 py-2 rounded-lg placeholder-gray-400" placeholder="Nombre de la Habilidad (ej: Comprensión Lectora)">
                                
                                <div class="bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm">
                                    <table class="w-full">
                                        <thead class="bg-gradient-to-r from-purple-100 to-blue-100">
                                            <tr>
                                                <th class="px-3 py-2 text-left text-xs font-bold text-purple-900 uppercase w-1/5">Indicador</th>
                                                <th class="px-3 py-2 text-left text-xs font-bold text-yellow-700 uppercase w-1/4">Inicial (1pt)</th>
                                                <th class="px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase w-1/4">Intermedio (2pts)</th>
                                                <th class="px-3 py-2 text-left text-xs font-bold text-green-700 uppercase w-1/4">Avanzado (3pts)</th>
                                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase w-16">Pts</th>
                                                <th class="px-2 py-2 w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody class="indicators-rubric-list divide-y divide-gray-100">
                                            ${indicatorsHTML}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <button onclick="app.addTareaIndicator(this)" class="mt-3 text-sm text-purple-600 font-bold hover:text-purple-700 hover:bg-purple-50 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    Agregar Indicador
                                </button>
                            `;
                            skillCont.appendChild(sDiv);
                        });
                    }
                } else {
                    document.getElementById('tarea-name').value = '';
                    document.getElementById('tarea-dates-container').innerHTML = '';
                    document.getElementById('tarea-skills-container').innerHTML = '';
                    addTareaDate(); addTareaSkill(); // Start with defaults
                }
                editor.classList.remove('hidden');
            }

            function closeTareaEditor() { document.getElementById('tarea-editor').classList.add('hidden'); currentEditingTareaId = null; }

            function saveTarea() {
                const name = document.getElementById('tarea-name').value;
                if (!name.trim()) return alert('Nombre requerido');

                const dateInputs = document.querySelectorAll('#tarea-dates-container input');
                const dates = Array.from(dateInputs).map(i => i.value).filter(d => d);
                if (!dates.length) return alert('Al menos una fecha requerida');

                const skillsDivs = document.querySelectorAll('#tarea-skills-container > div');
                const skills = Array.from(skillsDivs).map(div => {
                    const sName = div.querySelector('input[type="text"]').value;
                    const rows = div.querySelectorAll('.indicators-rubric-list tr');
                    const indicators = Array.from(rows).map(row => {
                        const inputs = row.querySelectorAll('input, textarea');
                        const name = inputs[0].value.trim();
                        const inicial = inputs[1].value.trim();
                        const intermedio = inputs[2].value.trim();
                        const avanzado = inputs[3].value.trim();

                        // Calculate max points based on filled levels
                        let max = 0;
                        if (inicial) max++;
                        if (intermedio) max++;
                        if (avanzado) max++;

                        return {
                            name,
                            max,
                            levels: {
                                inicial,
                                intermedio,
                                avanzado
                            }
                        };
                    }).filter(i => i.name && i.max > 0); // Only save indicators with name and at least one level
                    return { name: sName, indicators };
                }).filter(s => s.name.trim() && s.indicators.length);

                if (!skills.length) return alert('Al menos una habilidad con indicadores requerida');

                const acts = state.tareas[state.currentLevel][state.currentPeriod].activities;
                if (currentEditingTareaId) {
                    const idx = acts.findIndex(a => a.id === currentEditingTareaId);
                    if (idx >= 0) acts[idx] = { id: currentEditingTareaId, name, dates, skills };
                } else {
                    acts.push({ id: Date.now().toString(), name, dates, skills });
                }
                saveData();
                closeTareaEditor();
                renderTareasPanel();
            }

            function deleteTarea(id) {
                if (confirm('¿Eliminar tarea?')) {
                    const acts = state.tareas[state.currentLevel][state.currentPeriod].activities;
                    state.tareas[state.currentLevel][state.currentPeriod].activities = acts.filter(a => a.id !== id);
                    saveData(); renderTareasPanel(); closeTareaEditor();
                }
            }




            function renderTareasEvaluatorGrid() {
                const date = document.getElementById('eval-date-selector').value;
                const act = state.tareas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === currentEditingTareaId);
                if (!act || !date) return;

                const grid = document.getElementById('evaluator-grid-container');
                const students = state.students[state.currentLevel] || [];
                const periodData = state.tareas[state.currentLevel][state.currentPeriod];
                const actGrades = periodData.grades[act.id] || {};

                // Headers
                let html = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-100"><thead class="bg-gray-50"><tr>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase sticky left-0 bg-gray-50 z-10">Estudiante</th>`;

                // Dynamic Headers based on Indicators
                act.skills.forEach((skill, sIdx) => {
                    skill.indicators.forEach((ind, iIdx) => {
                        html += `<th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase border-l border-gray-200 min-w-[150px]">
                            <div class="line-clamp-2" title="${skill.name} - ${ind.name}">${ind.name}</div>
                            <div class="text-[10px] text-brand-500">Max: ${ind.max} pts</div>
                         </th>`;
                    });
                });
                html += `</tr></thead><tbody class="bg-white divide-y divide-gray-50">`;

                // Rows
                html += students.map(std => {
                    const stdGrades = actGrades[std.id] || {};

                    let cells = '';
                    let totalPts = 0;
                    let totalMax = 0;

                    act.skills.forEach((skill, sIdx) => {
                        skill.indicators.forEach((ind, iIdx) => {
                            const indId = `${sIdx}-${iIdx}`;
                            const score = stdGrades[indId]; // direct score
                            // Tareas might share standard of keeping scores by date? 
                            // Cotidiano keeps scores by indId inside stdGrades object directly for the activity? 
                            // Wait, Cotidiano structure: periodData.grades[act.id][std.id][indId] -> { date: score }
                            // Tareas Structure Plan: simpler? Just one score per indicator for the whole assignment?
                            // Usually assignments are "Turned in" once.
                            // But the UI has a Date Selector.
                            // If we support multiple dates, we follow Cotidiano pattern: stdGrades[indId] = { "2024-02-12": 5 }
                            const val = (stdGrades[indId] && stdGrades[indId][date] !== undefined) ? stdGrades[indId][date] : null;

                            if (val !== null) totalPts += val;
                            totalMax += ind.max;

                            // Dynamic Buttons Generation 0 to ind.max
                            let btns = '';
                            for (let i = 0; i <= ind.max; i++) {
                                const active = val === i ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/30 ring-2 ring-brand-500 ring-offset-1 transform scale-110' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200';
                                btns += `<button onclick="app.setTareaScore('${std.id}', '${indId}', ${i})" class="w-8 h-8 rounded-lg text-sm font-bold transition-all ${active}">${i}</button>`;
                            }


                            cells += `<td class="px-2 py-3 border-l border-gray-50">
                                <div class="flex flex-col gap-2">
                                    <div class="flex flex-wrap gap-1 justify-center max-w-[200px] mx-auto">${btns}</div>
                                    <textarea 
                                        id="obs-${std.id}-${indId}" 
                                        class="w-full text-xs border border-gray-200 rounded-lg px-2 py-1.5 resize-none focus:border-purple-400 focus:ring-2 focus:ring-purple-400/20 bg-gray-50/50" 
                                        rows="2" 
                                        placeholder="Observaciones..."
                                        onblur="app.saveTareaObservation('${std.id}', '${indId}', this.value)"
                                    >${stdGrades[indId]?.observation || ''}</textarea>
                                </div>
                             </td>`;
                        });
                    });

                    // Check if student delivered the task
                    const delivered = stdGrades.delivered !== false; // Default to true
                    const deliveryBtnClass = delivered ?
                        'bg-green-100 text-green-700 border-green-300' :
                        'bg-red-100 text-red-700 border-red-300';
                    const deliveryText = delivered ? 'Entregó' : 'No entregó';

                    return `<tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 sticky left-0 bg-white border-r border-gray-100 z-10">
                            <div class="flex flex-col gap-2">
                                <span class="text-sm font-bold text-gray-700">${std.name}</span>
                                <button 
                                    onclick="app.toggleTareaDelivery('${std.id}')" 
                                    class="text-xs font-bold px-2 py-1 rounded-lg border transition-all ${deliveryBtnClass}">
                                    ${deliveryText}
                                </button>
                            </div>
                        </td>
                        ${cells}
                     </tr>`;
                }).join('');

                html += `</tbody></table></div>`;
                grid.innerHTML = html;
                console.log('renderTareasEvaluatorGrid completed successfully');
            }

            function setTareaScore(stdId, indId, val) {
                const actId = currentEditingTareaId;
                const date = document.getElementById('eval-date-selector').value;
                const act = state.tareas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);

                if (!state.tareas[state.currentLevel][state.currentPeriod].grades[actId]) state.tareas[state.currentLevel][state.currentPeriod].grades[actId] = {};
                const actGrades = state.tareas[state.currentLevel][state.currentPeriod].grades[actId];

                if (!actGrades[stdId]) actGrades[stdId] = {};
                if (!actGrades[stdId][indId]) actGrades[stdId][indId] = {};

                // Toggle logic? Or just set?
                // If clicking same value, maybe clear it?
                if (actGrades[stdId][indId][date] === val) {
                    delete actGrades[stdId][indId][date];
                } else {
                    actGrades[stdId][indId][date] = val;

                    // Auto-populate positive message when max score is selected
                    const [sIdx, iIdx] = indId.split('-').map(Number);
                    const indicator = act.skills[sIdx]?.indicators[iIdx];
                    if (indicator && val === indicator.max && val > 0) {
                        const positiveMessages = [
                            '¡Excelente trabajo!',
                            '¡Muy bien hecho!',
                            '¡Buen trabajo!',
                            '¡Felicitaciones!',
                            '¡Sobresaliente!'
                        ];
                        const randomMessage = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];

                        // Only set if observation is empty
                        if (!actGrades[stdId][indId].observation || actGrades[stdId][indId].observation.trim() === '') {
                            actGrades[stdId][indId].observation = randomMessage;
                        }
                    }
                }

                saveData();
                renderTareasEvaluatorGrid();
            }

            function saveTareaObservation(stdId, indId, observation) {
                const actId = currentEditingTareaId;

                if (!state.tareas[state.currentLevel][state.currentPeriod].grades[actId]) state.tareas[state.currentLevel][state.currentPeriod].grades[actId] = {};
                const actGrades = state.tareas[state.currentLevel][state.currentPeriod].grades[actId];

                if (!actGrades[stdId]) actGrades[stdId] = {};
                if (!actGrades[stdId][indId]) actGrades[stdId][indId] = {};

                actGrades[stdId][indId].observation = observation;
                saveData();
            }

            function toggleTareaDelivery(stdId) {
                const actId = currentEditingTareaId;
                const date = document.getElementById('eval-date-selector').value;
                const act = state.tareas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);

                if (!state.tareas[state.currentLevel][state.currentPeriod].grades[actId]) state.tareas[state.currentLevel][state.currentPeriod].grades[actId] = {};
                const actGrades = state.tareas[state.currentLevel][state.currentPeriod].grades[actId];

                if (!actGrades[stdId]) actGrades[stdId] = {};

                // Toggle delivery status
                const currentStatus = actGrades[stdId].delivered !== false; // Default to true
                actGrades[stdId].delivered = !currentStatus;

                // If marking as not delivered, set all scores to 0 and add observation
                if (!actGrades[stdId].delivered) {
                    act.skills.forEach((skill, sIdx) => {
                        skill.indicators.forEach((ind, iIdx) => {
                            const indId = `${sIdx}-${iIdx}`;
                            if (!actGrades[stdId][indId]) actGrades[stdId][indId] = {};
                            actGrades[stdId][indId][date] = 0;
                            actGrades[stdId][indId].observation = 'No entregó la tarea';
                        });
                    });
                }

                saveData();
                renderTareasEvaluatorGrid();
            }

            function updateIndicatorPoints(textarea) {
                // Visual feedback: Calculate points for this row
                const tr = textarea.closest('tr');
                if (!tr) return;

                const inputs = tr.querySelectorAll('textarea.rubric-textarea');
                let count = 0;
                inputs.forEach(input => {
                    if (input.value.trim()) count++;
                });

                // Update the Pts cell (index 4)
                const ptsCell = tr.querySelectorAll('td')[4];
                if (ptsCell) {
                    ptsCell.innerHTML = `<span class="font-bold text-gray-700">${count}</span>`;
                }
            }

            function calculateTareasMetrics(studentId, period = state.currentPeriod) {
                // Debug log to confirm function entry
                // console.log(`[TareasMetrics] Calculating for student: ${studentId}, Period: ${period}`);

                const periodData = state.tareas[state.currentLevel]?.[period] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};

                let totalObtained = 0;
                let totalPossible = 0;

                activities.forEach(act => {
                    const actGrades = grades[act.id] || {};
                    const stdGrades = actGrades[studentId] || {};

                    if (act.skills) {
                        act.skills.forEach((skill, sIdx) => {
                            if (skill.indicators) {
                                skill.indicators.forEach((ind, iIdx) => {
                                    const indId = `${sIdx}-${iIdx}`;
                                    const indData = stdGrades[indId] || {};

                                    // Simple, safe score finding
                                    let best = 0;
                                    Object.entries(indData).forEach(([key, value]) => {
                                        if (key === 'observation' || key === 'delivered') return;
                                        const num = parseFloat(value);
                                        if (!isNaN(num) && isFinite(num)) {
                                            if (num > best) best = num;
                                        }
                                    });

                                    totalObtained += best;

                                    // Robust max points retrieval
                                    let maxPts = parseFloat(ind.max);
                                    if (isNaN(maxPts) || maxPts === 0) {
                                        if (ind.levels) {
                                            let calculated = 0;
                                            if (ind.levels.inicial) calculated++;
                                            if (ind.levels.intermedio) calculated++;
                                            if (ind.levels.avanzado) calculated++;
                                            maxPts = calculated > 0 ? calculated : 3;
                                        } else {
                                            maxPts = 3;
                                        }
                                    }
                                    totalPossible += maxPts;
                                });
                            }
                        });
                    }
                });

                const grade = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;
                // Constants: Tareas is 10%
                const percentage = (grade * 10) / 100;

                // console.log(`[TareasMetrics] Result for ${studentId}: Grade=${grade}, %=${percentage} (${totalObtained}/${totalPossible})`);

                return {
                    grade: isNaN(grade) ? 0 : grade,
                    percentage: isNaN(percentage) ? 0 : percentage,
                    totalObtained,
                    totalPossible,
                    possible: totalPossible
                };
            }

            function renderTareasSummaryReport() {
                console.log('[TareasReport] START RENDER');
                console.log(`[TareasReport] Level: ${state.currentLevel}, Period: ${state.currentPeriod}`);

                const headerRow = document.getElementById('ts-table-header');
                const body = document.getElementById('ts-table-body');
                if (!headerRow || !body) {
                    console.error('[TareasReport] Table elements not found!');
                    return;
                }

                // Update badges
                const levelBadge = document.getElementById('ts-level-badge');
                const periodBadge = document.getElementById('ts-period-badge');
                if (levelBadge) levelBadge.innerText = state.currentLevel;
                if (periodBadge) periodBadge.innerText = state.currentPeriod;

                // GetData
                const students = state.students[state.currentLevel] || [];
                console.log(`[TareasReport] Found ${students.length} students`);

                const periodData = state.tareas[state.currentLevel]?.[state.currentPeriod] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};

                // INTERNAL HELPER TO AVOID SCOPE ISSUES & FIX NAN
                const calculateMetricsV2 = (studentId) => {
                    let totalObtained = 0;
                    let totalPossible = 0;

                    activities.forEach(act => {
                        const actGrades = grades[act.id] || {};
                        const stdGrades = actGrades[studentId] || {};

                        if (act.skills) {
                            act.skills.forEach((skill, sIdx) => {
                                if (skill.indicators) {
                                    skill.indicators.forEach((ind, iIdx) => {
                                        const indId = `${sIdx}-${iIdx}`;
                                        const indData = stdGrades[indId] || {};

                                        // 1. Get Score
                                        const scores = Object.entries(indData)
                                            .filter(([key, value]) => key !== 'observation' && key !== 'delivered' && !isNaN(parseFloat(value)) && isFinite(value))
                                            .map(([_, value]) => parseFloat(value));
                                        const best = scores.length > 0 ? Math.max(...scores) : 0;
                                        totalObtained += best;

                                        // 2. Get Max Points (With Fallback)
                                        let maxPts = parseFloat(ind.max);
                                        if (isNaN(maxPts) || maxPts === 0) {
                                            // FALLBACK: Calculate from levels if max is missing
                                            if (ind.levels) {
                                                let calculated = 0;
                                                if (ind.levels.inicial) calculated++;
                                                if (ind.levels.intermedio) calculated++;
                                                if (ind.levels.avanzado) calculated++;
                                                maxPts = calculated > 0 ? calculated : 3; // Default to 3 if all else fails
                                                console.warn(`[TareasReport] Max points missing for "${ind.name}", fallback to ${maxPts}`);
                                            } else {
                                                maxPts = 3; // Hard fallback
                                            }
                                        }
                                        totalPossible += maxPts;
                                    });
                                }
                            });
                        }
                    });

                    const grade = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;
                    const percentage = (grade * 10) / 100;
                    console.log(`[TareasMetricsV2] ${studentId}: ${grade.toFixed(1)} (${totalObtained}/${totalPossible})`);
                    return { grade, percentage };
                };

                // 1. Render Headers
                let headersHTML = `<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase sticky left-0 bg-gray-50 z-20">Estudiante</th>`;
                activities.forEach(act => {
                    headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase min-w-[100px] border-l border-gray-100">
                         <div class="truncate w-24" title="${act.name}">${act.name}</div>
                     </th>`;
                });
                headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-brand-600 uppercase tracking-wider bg-blue-50 border-l border-blue-100">Nota Final</th>`;
                headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase tracking-wider bg-emerald-50 border-l border-emerald-100">%</th>`;
                headerRow.innerHTML = headersHTML;

                // 2. Render Rows
                if (students.length === 0) {
                    body.innerHTML = `<tr><td colspan="${activities.length + 3}" class="px-4 py-8 text-center text-gray-400">No hay estudiantes registrados en este nivel.</td></tr>`;
                    return;
                }

                const rowsHTML = students.map(s => {
                    const metrics = calculateMetricsV2(s.id);

                    const cellsHTML = activities.map(act => {
                        const actGrades = grades[act.id] || {};
                        const stdGrades = actGrades[s.id] || {};

                        let ob = 0;
                        let max = 0;

                        if (act.skills) {
                            act.skills.forEach((skill, sIdx) => {
                                if (skill.indicators) {
                                    skill.indicators.forEach((ind, iIdx) => {
                                        const indId = `${sIdx}-${iIdx}`;
                                        const indData = stdGrades[indId] || {};

                                        const scores = Object.entries(indData)
                                            .filter(([key, value]) => key !== 'observation' && key !== 'delivered' && !isNaN(parseFloat(value)) && isFinite(value))
                                            .map(([_, value]) => parseFloat(value));

                                        const best = scores.length > 0 ? Math.max(...scores) : 0;

                                        // Fallback Logic for Max Points (Legacy Data Support)
                                        let maxPts = parseFloat(ind.max);
                                        if (isNaN(maxPts) || maxPts === 0) {
                                            if (ind.levels) {
                                                let calculated = 0;
                                                if (ind.levels.inicial) calculated++;
                                                if (ind.levels.intermedio) calculated++;
                                                if (ind.levels.avanzado) calculated++;
                                                maxPts = calculated > 0 ? calculated : 3;
                                            } else {
                                                maxPts = 3;
                                            }
                                        }

                                        ob += best;
                                        max += maxPts;
                                    });
                                }
                            });
                        }

                        return `<td class="px-2 py-3 text-center text-sm border-r border-gray-50">
                             <span class="font-bold text-gray-700">${ob}</span> <span class="text-gray-400">/ ${max}</span>
                         </td>`;
                    }).join('');

                    return `<tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                         <td class="px-4 py-3 text-sm font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-100 shadow-sm z-20">${s.name}</td>
                         ${cellsHTML}
                         <td class="px-4 py-3 text-center font-bold text-brand-700 bg-blue-50/20 border-l border-blue-50">${metrics.grade.toFixed(1)}</td>
                         <td class="px-4 py-3 text-center font-extrabold text-emerald-700 bg-emerald-50/20 border-l border-emerald-50">${metrics.percentage.toFixed(1)}%</td>
                     </tr>`;
                }).join('');

                body.innerHTML = rowsHTML;
                console.log('[TareasReport] RENDER COMPLETE');
            }

            // Helpers for Tareas Editor
            function addTareaDate() {
                const c = document.getElementById('tarea-dates-container');
                const div = document.createElement('div'); div.className = 'flex items-center gap-1 mb-2';
                div.innerHTML = `<input type="date" class="border border-gray-200 rounded-lg px-2 py-1 text-sm"><button onclick="app.deleteTareaDate(this)" class="text-red-400 hover:text-red-600"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
                c.appendChild(div);
            }
            function deleteTareaDate(btn) { btn.parentElement.remove(); }

            function addTareaSkill() {
                const c = document.getElementById('tarea-skills-container');
                const div = document.createElement('div');
                div.className = 'bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 border border-purple-100 relative group animate-fade-in shadow-sm';
                div.innerHTML = `
                    <button onclick="app.deleteTareaSkill(this)" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <input type="text" class="w-full font-bold bg-white/70 border-2 border-transparent focus:border-purple-400 outline-none text-slate-800 mb-4 px-3 py-2 rounded-lg placeholder-gray-400" placeholder="Nombre de la Habilidad (ej: Comprensión Lectora)">
                    
                    <div class="bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-purple-100 to-blue-100">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-purple-900 uppercase w-1/5">Indicador</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-yellow-700 uppercase w-1/4">Inicial (1pt)</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase w-1/4">Intermedio (2pts)</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-blue-700 uppercase w-1/4">Avanzado (3pts)</th>
                                    <th class="px-3 py-2 text-center text-xs font-bold text-gray-700 uppercase w-16">Pts</th>
                                    <th class="px-2 py-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="indicators-rubric-list divide-y divide-gray-100">
                                <!-- Indicators will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <button onclick="app.addTareaIndicator(this)" class="mt-3 text-sm text-purple-600 font-bold hover:text-purple-700 hover:bg-purple-50 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Agregar Indicador
                    </button>
                `;
                c.appendChild(div);
            }

            function deleteTareaSkill(btn) { btn.parentElement.remove(); }

            function addTareaIndicator(btn) {
                const tbody = btn.parentElement.querySelector('.indicators-rubric-list');
                const tr = document.createElement('tr');
                tr.className = 'animate-fade-in hover:bg-gray-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-3 py-2">
                        <textarea class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 resize-none overflow-hidden font-medium" 
                            placeholder="Nombre del indicador" 
                            rows="1"
                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px';"></textarea>
                    </td>
                    <td class="px-3 py-2">
                        <textarea class="w-full border border-yellow-200 bg-yellow-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 resize-none overflow-hidden rubric-textarea" 
                            placeholder="Describe el nivel básico..." 
                            rows="2"
                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);"></textarea>
                    </td>
                    <td class="px-3 py-2">
                        <textarea class="w-full border border-blue-200 bg-blue-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 resize-none overflow-hidden rubric-textarea" 
                            placeholder="Describe el nivel medio..." 
                            rows="2"
                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);"></textarea>
                    </td>
                    <td class="px-3 py-2">
                        <textarea class="w-full border border-green-200 bg-green-50/30 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20 resize-none overflow-hidden rubric-textarea" 
                            placeholder="Describe el nivel avanzado..." 
                            rows="2"
                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'; app.updateIndicatorPoints(this);"></textarea>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <span class="indicator-points-display inline-block bg-gray-100 text-gray-700 font-bold text-sm px-2 py-1 rounded-lg min-w-[2rem]">0</span>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="app.deleteTareaIndicator(this)" class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }

            function deleteTareaIndicator(btn) {
                btn.closest('tr').remove();
            }

            function updateIndicatorPoints(textarea) {
                const row = textarea.closest('tr');
                const textareas = row.querySelectorAll('.rubric-textarea');
                let points = 0;
                textareas.forEach(ta => {
                    if (ta.value.trim().length > 0) points++;
                });
                const display = row.querySelector('.indicator-points-display');
                display.textContent = points;
                display.className = `indicator-points-display inline-block font-bold text-sm px-2 py-1 rounded-lg min-w-[2rem] ${points === 0 ? 'bg-gray-100 text-gray-700' :
                    points === 1 ? 'bg-yellow-100 text-yellow-700' :
                        points === 2 ? 'bg-blue-100 text-blue-700' :
                            'bg-green-100 text-green-700'
                    }`;
            }

            // Expose new Tareas methods
            // Note: need to update return statement of app IIFE to include these.
            // Since this replacement block is inside the IIFE body but before the return (if I replace correctly), 
            // I need to make sure I update the return object.
            // The replace_file_content tool replaces a BLOCK. I need to be careful.
            // The TargetContent above includes `if (viewId === 'cotidiano-view')`.
            // I should target the `navigateTo` function and then append the new functions, WITHOUT overwriting the return statement yet, 
            // OR I should do a separate edit to update the return statement.
            // Given the complexity, I'll assume I can just add the functions now and update the export in a separate step or same step if I targeting wider range.
            // I'll target `navigateTo` and append the functions. Then I will need another edit to expose them in `return { ... }`.


            function setPeriod(p) {
                state.currentPeriod = p;
                if (p === 1) { els.period1Btn.classList.remove('text-gray-400', 'hover:text-gray-600', 'hover:bg-white/50'); els.period1Btn.classList.add('shadow-md', 'bg-white', 'ring-1', 'ring-gray-100', 'transform', 'scale-105', 'text-brand-600'); els.period2Btn.className = 'px-4 py-1.5 text-sm font-medium rounded-xl transition-all text-gray-400 hover:text-gray-600 hover:bg-white/50'; document.documentElement.style.setProperty('--brand-color', CONSTANTS.COLORS.P1.hex); }
                else { els.period2Btn.classList.remove('text-gray-400', 'hover:text-gray-600', 'hover:bg-white/50'); els.period2Btn.classList.add('shadow-md', 'bg-white', 'ring-1', 'ring-gray-100', 'transform', 'scale-105', 'text-emerald-600'); els.period1Btn.className = 'px-4 py-1.5 text-sm font-medium rounded-xl transition-all text-gray-400 hover:text-gray-600 hover:bg-white/50'; document.documentElement.style.setProperty('--brand-color', CONSTANTS.COLORS.P2.hex); }
                renderUI();
            }

            function setupGenericView(title, viewId) { els.rubricTitle.innerText = title; els.rubricViewName.innerText = viewId; }
            function renderUI() { updatePercentages(); }

            function updatePercentages() {
                const percs = ['10', '11'].includes(state.currentLevel) ? CONSTANTS.PERCENTAGES.UPPER : CONSTANTS.PERCENTAGES.LOWER;
                els.percentCotidiano.innerText = `${percs.cotidiano}%`; els.percentPruebas.innerText = `${percs.pruebas}%`;
            }

            function setupEventListeners() {
                els.levelSelector.addEventListener('change', (e) => { state.currentLevel = e.target.value; renderUI(); });
                els.csvUpload.addEventListener('change', handleCSVUpload);
                els.studentSearch.addEventListener('input', (e) => handleSearch(e.target.value));
            }

            // STUDENT MANAGEMENT
            function handleCSVUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

                    if (lines.length < 2) return alert('El archivo parece estar vacío o sin datos.');

                    // Auto-detect delimiter from header
                    const header = lines[0];
                    const delimiter = header.includes(';') ? ';' : ',';

                    let addedCount = 0;

                    // Process from line 1 (skip header)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        // Split by delimiter, handling potential quotes is hard without regex, 
                        // but for now simple split by detected delimiter is safer than mixed /[,;]/
                        // If complex parsing is needed, a mini-parser is better.
                        // Let's stick to simple split but consistent with detected delimiter.

                        // Handle quotes stripped if present
                        const rows = line.split(delimiter).map(cell => cell.trim().replace(/^"|"$/g, ''));

                        if (rows.length >= 2) {
                            const id = rows[0];
                            const name = rows[1];

                            if (id && name) {
                                // Prevent duplicates
                                if (!state.students[state.currentLevel]) state.students[state.currentLevel] = [];

                                const exists = state.students[state.currentLevel].find(s => s.id === id);
                                if (!exists) {
                                    state.students[state.currentLevel].push({
                                        id,
                                        name,
                                        email: rows[2] || '',
                                        section: rows[3] || '',
                                        grades: { p1: {}, p2: {} }
                                    });
                                    addedCount++;
                                }
                            }
                        }
                    }

                    saveData();
                    alert(`${addedCount} estudiantes importados correctamente usando separador: '${delimiter}'`);
                    renderConfigStudentList();
                    renderUI(); // Update counts
                    e.target.value = '';
                };
                reader.readAsText(file);
            }

            function renderConfigStudentList() {
                const list = state.students[state.currentLevel] || [];
                els.configStudentList.innerHTML = list.map(s => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.id}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.name}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="app.deleteStudent('${s.id}')" class="text-red-600 hover:text-red-900 font-bold bg-red-50 px-3 py-1 rounded-lg">Eliminar</button></td></tr>`).join('');
            }

            function addStudentManual() {
                const id = els.newStudentId.value.trim(); const name = els.newStudentName.value.trim();
                if (!id || !name) return alert('ID y Nombre requeridos');
                if (state.students[state.currentLevel].find(s => s.id === id)) return alert('Ya existe');
                state.students[state.currentLevel].push({ id, name, grades: { p1: {}, p2: {} } });
                saveData(); renderConfigStudentList(); els.newStudentId.value = ''; els.newStudentName.value = '';
            }
            function deleteStudent(id) {
                if (confirm('¿Seguro?')) { state.students[state.currentLevel] = state.students[state.currentLevel].filter(s => s.id !== id); saveData(); renderConfigStudentList(); }
            }
            function downloadTemplate() {
                const csvContent = "data:text/csv;charset=utf-8,ID;Nombre Completo\n12345,Juan Pérez";
                const encodedUri = encodeURI(csvContent); const link = document.createElement("a");
                link.setAttribute("href", encodedUri); link.setAttribute("download", "plantilla_estudiantes.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
            function exportCSV() {
                const list = state.students[state.currentLevel] || [];
                if (list.length === 0) return alert('No hay estudiantes para exportar.');

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID;Nombre;Cotidiano %;Tareas %;Pruebas %;Asistencia %;Nota Final\n";

                list.forEach(s => {
                    const coti = calculateCotidianoMetrics(s.id).percentage || 0;
                    const tareas = calculateTareasMetrics(s.id).percentage || 0;
                    const pruebas = calculatePruebasMetrics(s.id).percentage || 0;
                    const att = calculateAttendanceMetrics(s.id).percentage || 0;
                    const final = coti + tareas + pruebas + att;

                    csvContent += `${s.id};${s.name};${coti.toFixed(2).replace('.', ',')};${tareas.toFixed(2).replace('.', ',')};${pruebas.toFixed(2).replace('.', ',')};${att.toFixed(2).replace('.', ',')};${final.toFixed(2).replace('.', ',')}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `registro_nivel_${state.currentLevel}_periodo_${state.currentPeriod}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function handleSearch(query) {
                if (query.length < 2) { els.searchResults.classList.add('hidden'); return; }
                const results = [];
                Object.keys(state.students).forEach(lvl => {
                    state.students[lvl].forEach(s => {
                        if (s.name.toLowerCase().includes(query.toLowerCase())) results.push({ ...s, level: lvl });
                    });
                });
                els.searchResults.innerHTML = results.slice(0, 5).map(s => `<div onclick="app.getStudent('${s.id}', '${s.level}')" class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0"><p class="text-sm font-bold text-gray-800">${s.name}</p><p class="text-xs text-brand-500">Nivel ${s.level} - ID: ${s.id}</p></div>`).join('');
                els.searchResults.classList.remove('hidden');
            }
            function getStudent(id, level) {
                const s = state.students[level].find(st => st.id === id);
                if (s) {
                    state.currentLevel = level;
                    navigateTo('student-view', { student: s });
                    els.searchResults.classList.add('hidden');
                    // Force clear direct access
                    const searchInput = document.getElementById('student-search');
                    if (searchInput) searchInput.value = '';
                }
            }

            function calculatePeriodGrade(stdId, period) {
                const coti = calculateCotidianoMetrics(stdId, period).percentage || 0;
                const tareas = calculateTareasMetrics(stdId, period).percentage || 0;
                const pruebas = calculatePruebasMetricsV2(stdId, period).percentage || 0;
                const att = calculateAttendanceMetrics(stdId, period).percentage || 0;

                return coti + tareas + pruebas + att;
            }

            function renderAnnualSummary(stdId) {
                const container = document.getElementById('std-annual-summary');
                if (!container) return;

                const gradeP1 = calculatePeriodGrade(stdId, 1);
                const gradeP2 = calculatePeriodGrade(stdId, 2);

                const annP1 = gradeP1 * 0.50;
                const annP2 = gradeP2 * 0.50;
                const finalAnnual = annP1 + annP2;

                // Approval Logic
                const isUpper = ['10', '11'].includes(state.currentLevel);
                const passingGrade = isUpper ? 70 : 65;
                const isApproved = finalAnnual >= passingGrade;
                const statusText = isApproved ? 'APROBADO' : 'APLAZADO';
                const statusColor = isApproved ? 'text-emerald-700 bg-emerald-50 border-emerald-200' : 'text-red-700 bg-red-50 border-red-200';
                const statusIcon = isApproved ?
                    `<svg class="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` :
                    `<svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                container.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-6 shadow-sm">
                        
                        <div class="flex items-center gap-6 divide-x divide-gray-200">
                             <!-- Period 1 -->
                            <div class="flex flex-col items-center px-4">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">I Periodo (50%)</span>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-xl font-bold text-slate-700">${gradeP1.toFixed(2)}</span>
                                    <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded">${annP1.toFixed(2)}%</span>
                                </div>
                            </div>
    
                            <!-- Period 2 -->
                            <div class="flex flex-col items-center px-4">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">II Periodo (50%)</span>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-xl font-bold text-slate-700">${gradeP2.toFixed(2)}</span>
                                    <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded">${annP2.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Annual Final -->
                        <div class="flex items-center gap-4 bg-white px-5 py-3 rounded-xl border border-gray-100 shadow-sm w-full md:w-auto justify-between md:justify-start">
                             <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Nota Anual</span>
                                <span class="text-2xl font-extrabold text-slate-800 tracking-tight">${finalAnnual.toFixed(2)}</span>
                            </div>
                            
                            <div class="h-8 w-px bg-gray-100 mx-2"></div>

                            <div class="flex flex-col items-end">
                                <div class="flex items-center gap-1.5 mb-1">
                                    ${statusIcon}
                                    <span class="${isApproved ? 'text-emerald-700' : 'text-red-700'} font-bold text-sm uppercase">${statusText}</span>
                                </div>
                                <span class="text-[10px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-gray-100">Mínimo: ${passingGrade}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            function loadStudentView(student) {
                els.stdName.innerText = student.name; els.stdId.innerText = `ID: ${student.id}`; els.stdLevel.innerText = `Nivel ${state.currentLevel}`;
                // Simplified grade loading
                const pKey = `p${state.currentPeriod}`;
                const grades = (student.grades && student.grades[pKey]) ? student.grades[pKey] : {};
                const percs = ['10', '11'].includes(state.currentLevel) ? CONSTANTS.PERCENTAGES.UPPER : CONSTANTS.PERCENTAGES.LOWER;

                const setBar = (elId, barId, val, weight) => {
                    const el = document.getElementById(elId); const bar = document.getElementById(barId);
                    if (el && bar) {
                        const widthVal = (val * 100 / weight);
                        el.innerText = `${val.toFixed(2)}%`;
                        bar.style.width = `${Math.min(widthVal, 100)}%`;
                    }
                };

                const attStats = calculateAttendanceMetrics(student.id);
                const cotidianoStats = calculateCotidianoMetrics(student.id);
                const tareasStats = calculateTareasMetrics(student.id);
                const pruebasStats = calculatePruebasMetrics(student.id);

                setBar('std-grade-cotidiano', 'std-bar-cotidiano', cotidianoStats.percentage || 0, percs.cotidiano);
                setBar('std-grade-tareas', 'std-bar-tareas', tareasStats.percentage || 0, percs.tareas);
                setBar('std-grade-pruebas', 'std-bar-pruebas', pruebasStats.percentage || 0, percs.pruebas);
                setBar('std-grade-asistencia', 'std-bar-asistencia', attStats.percentage || 0, percs.asistencia);

                // Final Grade Config
                const finalGrade = (cotidianoStats.percentage || 0) + (tareasStats.percentage || 0) + (pruebasStats.percentage || 0) + (attStats.percentage || 0);
                document.getElementById('std-final-grade').innerText = finalGrade.toFixed(2);

                renderStudentAttendanceHistory(student.id);
                renderStudentCotidianoHistory(student.id);
                renderStudentTareasHistory(student.id);
                renderStudentPruebasHistory(student.id);

                // Annual Summary
                renderAnnualSummary(student.id);
            }

            function renderStudentTareasHistory(stdId) {
                const list = document.getElementById('std-tareas-history-list');
                const empty = document.getElementById('std-tareas-empty');
                const badge = document.getElementById('std-tareas-grade-badge');

                if (badge && badge.nextElementSibling) badge.nextElementSibling.innerText = 'Nota';

                if (!list || !empty) return;

                const levelData = state.tareas[state.currentLevel] || {};
                const periodData = levelData[state.currentPeriod] || { activities: [], grades: {} };
                const activities = Array.isArray(periodData.activities) ? periodData.activities : [];
                const grades = periodData.grades || {};

                if (activities.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    if (badge) badge.innerText = '0%';
                    return;
                }

                empty.classList.add('hidden');

                list.innerHTML = activities.map(act => {
                    const actGrades = grades[act.id] || {};
                    const stdActGrades = actGrades[stdId] || {};

                    let totalObtained = 0;
                    let totalPossible = 0;

                    // Build Details Table HTML
                    let detailsHTML = `
                        <div class="rounded-lg overflow-hidden border border-gray-200 bg-white shadow-sm mt-3">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500">
                                    <tr>
                                        <th class="px-3 py-2 text-left w-1/5">Indicador</th>
                                        <th class="px-3 py-2 text-left w-1/5 text-yellow-700 bg-yellow-50/50 border-l border-yellow-100">Inicial (1)</th>
                                        <th class="px-3 py-2 text-left w-1/5 text-blue-700 bg-blue-50/50 border-l border-blue-100">Intermedio (2)</th>
                                        <th class="px-3 py-2 text-left w-1/5 text-green-700 bg-green-50/50 border-l border-green-100">Avanzado (3)</th>
                                        <th class="px-3 py-2 text-center w-16 border-l border-gray-200 bg-gray-50">Pts</th>
                                        <th class="px-3 py-2 text-left border-l border-gray-200">Obs</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                    `;

                    // Calculate metrics for this specific task
                    act.skills.forEach((skill, sIdx) => {
                        // Skill Header
                        detailsHTML += `<tr class="bg-slate-50/50"><td colspan="6" class="px-4 py-1.5 font-bold text-slate-700 text-xs uppercase tracking-wide border-t border-b border-gray-100">${skill.name}</td></tr>`;

                        skill.indicators.forEach((ind, iIdx) => {
                            // Use fallback logic for max points (Robust V2 Logic)
                            let maxPts = parseFloat(ind.max);
                            if (isNaN(maxPts) || maxPts === 0) {
                                if (ind.levels) {
                                    let calculated = 0;
                                    if (ind.levels.inicial) calculated++;
                                    if (ind.levels.intermedio) calculated++;
                                    if (ind.levels.avanzado) calculated++;
                                    maxPts = calculated > 0 ? calculated : 3;
                                } else {
                                    maxPts = 3;
                                }
                            }
                            totalPossible += maxPts;

                            // Get obtained score
                            const indId = `${sIdx}-${iIdx}`;

                            // Robust score retrieval (filter out metadata and cast to number)
                            const indData = stdActGrades[indId] || {};

                            // Simple, safe score finding
                            let best = 0;
                            let hasScore = false;
                            Object.entries(indData).forEach(([key, value]) => {
                                if (key === 'observation' || key === 'delivered') return;
                                const num = parseFloat(value);
                                if (!isNaN(num) && isFinite(num)) {
                                    hasScore = true;
                                    if (num > best) best = num;
                                }
                            });

                            totalObtained += best;

                            // Observation
                            const obs = indData.observation || '';

                            // Level Descriptions (Safe Access)
                            const levels = ind.levels || {};
                            const l1 = levels.inicial || '-';
                            const l2 = levels.intermedio || '-';
                            const l3 = levels.avanzado || '-';

                            // Highlight Logic
                            const h1 = (hasScore && best === 1) ? 'bg-yellow-100 ring-2 ring-inset ring-yellow-400 font-medium text-yellow-900' : 'text-gray-500';
                            const h2 = (hasScore && best === 2) ? 'bg-blue-100 ring-2 ring-inset ring-blue-400 font-medium text-blue-900' : 'text-gray-500';
                            const h3 = (hasScore && best === 3) ? 'bg-green-100 ring-2 ring-inset ring-green-400 font-medium text-green-900' : 'text-gray-500';

                            const scoreClass = hasScore ? 'font-bold text-slate-700' : 'text-gray-300';

                            detailsHTML += `
                                <tr>
                                    <td class="px-3 py-2 font-medium text-gray-700 text-xs">${ind.name || ind}</td>
                                    <td class="px-3 py-2 text-xs border-l border-yellow-50 ${h1}">${l1}</td>
                                    <td class="px-3 py-2 text-xs border-l border-blue-50 ${h2}">${l2}</td>
                                    <td class="px-3 py-2 text-xs border-l border-green-50 ${h3}">${l3}</td>
                                    <td class="px-3 py-2 text-center border-l border-gray-100 bg-gray-50/30 ${scoreClass}">${hasScore ? best : '-'}</td>
                                    <td class="px-3 py-2 text-xs italic text-gray-500 border-l border-gray-100">${obs}</td>
                                </tr>
                            `;
                        });
                    });

                    detailsHTML += `</tbody></table></div>`;

                    // Calculate Percentage for this task
                    const grade = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;
                    let colorClass = 'text-red-600';
                    if (grade >= 80) colorClass = 'text-green-600';
                    else if (grade >= 60) colorClass = 'text-yellow-600';

                    return `
                        <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-50 last:border-0">
                            <td colspan="3" class="p-0">
                                <div class="px-4 py-3 cursor-pointer flex justify-between items-center hover:bg-gray-50 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180')">
                                    <div class="flex-1">
                                         <div class="flex items-baseline gap-2">
                                            <span class="font-bold text-gray-900">${act.name}</span>
                                            <span class="text-xs text-gray-400 font-mono">(${totalObtained} / ${totalPossible} pts)</span>
                                         </div>
                                         <span class="block text-xs text-gray-400 mt-0.5">${act.dates.join(', ')}</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="${colorClass} text-sm font-bold px-3 py-1 rounded-full bg-gray-50 border border-gray-100 min-w-[60px] text-center">${grade.toFixed(0)}%</span>
                                        <svg class="w-4 h-4 text-gray-400 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                </div>
                                <div class="details-container px-4 pb-4 bg-gray-50/30 hidden transition-all">
                                    ${detailsHTML}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update badge with overall module score
                const metrics = calculateTareasMetrics(stdId);
                console.log(`[TareasHistory] Overall Metrics for ${stdId}:`, metrics);

                if (badge) {
                    const badgeVal = (metrics.percentage !== undefined && !isNaN(metrics.percentage)) ? metrics.percentage.toFixed(1) : '0.0';
                    badge.innerText = badgeVal + '%';
                }
            }

            function renderStudentPruebasHistory(stdId) {
                const list = document.getElementById('std-pruebas-history-list');
                const empty = document.getElementById('std-pruebas-empty');
                const badge = document.getElementById('std-pruebas-grade-badge');

                // Update badge with overall score
                const metrics = calculatePruebasMetricsV2(stdId);
                if (badge) {
                    // Change label to "Nota" if needed
                    if (badge.nextElementSibling) badge.nextElementSibling.innerText = 'Nota';
                    const badgeVal = (metrics.percentage !== undefined && !isNaN(metrics.percentage)) ? metrics.percentage.toFixed(1) : '0.0';
                    badge.innerText = badgeVal + '%';
                }

                if (!list || !empty) return;

                const levelData = state.pruebas[state.currentLevel] || {};
                const periodData = levelData[state.currentPeriod] || { activities: [], grades: {}, overrides: {} };
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};
                const overrides = periodData.overrides || {};

                if (activities.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');

                list.innerHTML = activities.map(act => {
                    // Check for overrides
                    const stdOverrides = overrides[stdId] && overrides[stdId][act.id] ? overrides[stdId][act.id] : {};
                    const isAS = stdOverrides.isAS;

                    const date = (isAS && stdOverrides.date) ? stdOverrides.date : act.date;
                    const maxPts = (isAS && stdOverrides.points) ? parseFloat(stdOverrides.points) : parseFloat(act.points);
                    const percentage = (isAS && stdOverrides.percentage) ? parseFloat(stdOverrides.percentage) : parseFloat(act.percentage);

                    const actGrades = grades[act.id] || {};
                    const scoreVal = actGrades[stdId];

                    let grade = 0;
                    let earnedPct = 0;
                    let displayScore = '-';

                    if (scoreVal !== undefined && scoreVal !== '' && !isNaN(parseFloat(scoreVal))) {
                        displayScore = scoreVal;
                        if (maxPts > 0) {
                            grade = (parseFloat(scoreVal) / maxPts) * 100;
                            earnedPct = (parseFloat(scoreVal) / maxPts) * percentage;
                        }
                    }

                    const gradeClass = grade >= 65 ? 'text-green-600' : 'text-red-500';

                    return `
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                            <td class="px-4 py-3">
                                <span class="font-bold text-slate-800 text-sm block">${act.name}</span>
                                ${isAS ? '<span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 mt-1 inline-block">Adecuación</span>' : ''}
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-gray-500">${date}</td>
                            <td class="px-4 py-3 text-center text-sm font-medium text-gray-600">${maxPts} pts</td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-sm font-bold ${gradeClass}">${Math.round(grade)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-sm font-bold text-slate-700">${earnedPct.toFixed(1)}%</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function renderStudentCotidianoHistory(stdId) {
                const list = document.getElementById('std-coti-history-list');
                const empty = document.getElementById('std-coti-empty');
                const badge = document.getElementById('std-coti-grade-badge');
                // Update Label if possible - assumed static HTML "Promedio", changing via JS or manual HTML update locally? 
                // The label "Promedio" is in the HTML. I should target it if I can, or just update the badge value.
                // The user said "que en lugar de decir promedio, que diga nota". 
                // I will assume I need to find the label element. 
                // Looking at previous code, the label spans were:
                // <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Promedio</span>
                // It doesn't have an ID. I can try to access it via sibling of badge.
                if (badge && badge.nextElementSibling) badge.nextElementSibling.innerText = 'Nota';

                if (!list || !empty) return;

                const levelData = state.cotidiano[state.currentLevel] || {};
                const periodData = levelData[state.currentPeriod] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};

                if (activities.length === 0) {
                    list.innerHTML = '';
                    empty.classList.remove('hidden');
                    if (badge) badge.innerText = '0%';
                    return;
                }

                empty.classList.add('hidden');

                // Attendance Data
                const attPeriodData = state.attendance[state.currentLevel] && state.attendance[state.currentLevel][state.currentPeriod] ? state.attendance[state.currentLevel][state.currentPeriod] : {};

                list.innerHTML = activities.map(act => {
                    const allAbsent = act.dates.every(d => {
                        const dayAtt = attPeriodData[d];
                        if (!dayAtt) return false;
                        const stdAtt = dayAtt.students[stdId];
                        return stdAtt && (stdAtt.status === 'AI' || stdAtt.status === 'AJ') && (dayAtt.totalLessons > 0 && stdAtt.lessons >= dayAtt.totalLessons);
                    });

                    const actGrades = grades[act.id] || {};
                    const stdActGrades = actGrades[stdId] || {};

                    let totalPts = 0;
                    let maxPts = 0;

                    act.skills.forEach((s, si) => s.indicators.forEach((ind, ii) => {
                        maxPts += 3;
                        const iId = `${si}-${ii}`;
                        if (stdActGrades[iId]) {
                            const scores = Object.values(stdActGrades[iId]);
                            if (scores.length) totalPts += Math.max(...scores);
                        }
                    }));

                    const grade0to3 = maxPts > 0 ? Math.round((totalPts / maxPts) * 3) : 0;

                    const gradeColor = grade0to3 >= 3 ? 'text-green-600 bg-green-50' : (grade0to3 >= 2 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50');

                    if (allAbsent) {
                        return `
                        <tr class="hover:bg-gray-50 transition-colors bg-gray-50/50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-500 border-b border-gray-50">
                                ${act.name}
                                <span class="block text-xs text-gray-400">${act.dates.join(', ')}</span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-gray-400 border-b border-gray-50 font-mono">
                                - / ${maxPts}
                            </td>
                            <td class="px-4 py-3 text-center border-b border-gray-50">
                                <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded inline-block">AUSENTE</span>
                            </td>
                            <td class="px-4 py-3 text-center border-b border-gray-50">
                                <span class="text-xs font-bold text-gray-400">No aplica</span>
                            </td>
                        </tr>`;
                    }

                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900 border-b border-gray-50">
                                ${act.name}
                                <span class="block text-xs text-gray-400">${act.dates.join(', ')}</span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600 border-b border-gray-50 font-mono">
                                ${totalPts} / ${maxPts}
                            </td>
                            <td class="px-4 py-3 text-center border-b border-gray-50">
                                <span class="${gradeColor} text-xs font-bold px-2 py-1 rounded inline-block min-w-[30px]">${grade0to3}</span>
                            </td>
                            <td class="px-4 py-3 text-center border-b border-gray-50">
                                <span class="text-xs font-bold ${grade0to3 >= 2 ? 'text-emerald-500' : 'text-red-500'}">
                                    ${grade0to3 >= 2 ? 'Aprobado' : 'Revisar'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

                const metrics = calculateCotidianoMetrics(stdId);
                if (badge) badge.innerText = metrics.percentage.toFixed(1) + '%';
            }

            // Separating built-in attendance history logic if it was inline to avoid duplication or errors
            function renderStudentAttendanceHistory(stdId) {
                const list = document.getElementById('std-att-history-list');
                const empty = document.getElementById('std-att-empty');
                if (!list) return;

                // ... (Rest of logic was visible in lines 1000+? No, simpler to just assume it's there or I need to see it)
                // The view stopped at 1000. I'll read 1000-1100 to ensure I don't break existing attendance history.
                const tbody = document.getElementById('std-att-history-list');
                const emptyMsg = document.getElementById('std-att-empty');
                const badge = document.getElementById('std-att-grade-badge');
                const elAI = document.getElementById('std-att-ai');
                const elAJ = document.getElementById('std-att-aj');
                const elT = document.getElementById('std-att-t');

                if (tbody) {
                    tbody.innerHTML = '';

                    // Calculate and Set Stats
                    const stats = calculateAttendanceMetrics(stdId);
                    if (badge) badge.innerText = `${stats.percentage.toFixed(1)}%`;
                    if (elAI) elAI.innerText = stats.ai;
                    if (elAJ) elAJ.innerText = stats.aj;
                    if (elT) elT.innerText = stats.t;

                    // Render List
                    const attData = state.attendance[state.currentLevel] && state.attendance[state.currentLevel][state.currentPeriod]
                        ? state.attendance[state.currentLevel][state.currentPeriod] : {};

                    const dates = Object.keys(attData).sort().reverse();

                    if (dates.length === 0) {
                        if (emptyMsg) emptyMsg.classList.remove('hidden');
                    } else {
                        if (emptyMsg) emptyMsg.classList.add('hidden');
                        let hasRecords = false;

                        dates.forEach(date => {
                            const dayData = attData[date];
                            const stdData = dayData.students[stdId];
                            if (stdData && stdData.status !== 'P') {
                                hasRecords = true;
                                const status = stdData.status;
                                const lessons = stdData.lessons;

                                let colorClass = 'text-gray-500';
                                let label = 'Presente';
                                let bgClass = 'bg-gray-50';

                                if (status === 'AI') { colorClass = 'text-red-600'; bgClass = 'bg-red-50'; label = 'Ausencia Inj.'; }
                                if (status === 'AJ') { colorClass = 'text-blue-600'; bgClass = 'bg-blue-50'; label = 'Ausencia Just.'; }
                                if (status === 'T') { colorClass = 'text-yellow-600'; bgClass = 'bg-yellow-50'; label = 'Tardía'; }

                                const row = `
                                    <tr>
                                        <td class="px-0 py-3 border-b border-gray-50 last:border-0">
                                            <span class="block text-xs font-bold text-gray-400 mb-1">${date}</span>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs font-extrabold ${colorClass} ${bgClass} px-2 py-1 rounded w-24 text-center block">${label}</span>
                                                <span class="text-xs font-medium text-gray-500">${lessons} lecciones</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                                tbody.innerHTML += row;
                            }
                        });

                        if (!hasRecords) {
                            if (emptyMsg) emptyMsg.classList.remove('hidden');
                        }

                        if (!hasRecords && emptyMsg) emptyMsg.classList.remove('hidden');
                    }
                }
            }

            // Tareas Metrics function moved to line 1752 to avoid duplication

            // PRUEBAS METRICS
            function calculatePruebasMetrics(stdId) {
                if (!state.pruebas[state.currentLevel] || !state.pruebas[state.currentLevel][state.currentPeriod]) {
                    return { percentage: 0, details: [] };
                }
                const periodData = state.pruebas[state.currentLevel][state.currentPeriod];
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};

                let totalPercentage = 0;

                const details = activities.map(act => {
                    const actGrades = grades[act.id] || {};
                    const val = actGrades[stdId];
                    if (val !== undefined && !isNaN(val)) {
                        const earned = (parseFloat(val) / act.totalPoints) * act.weight;
                        totalPercentage += earned;
                        return { name: act.name, earned, weight: act.weight, score: val, max: act.totalPoints };
                    }
                    return { name: act.name, earned: 0, weight: act.weight, score: 0, max: act.totalPoints, missing: true };
                });

                return { percentage: totalPercentage, details };
            }

            // ATTENDANCE LOGIC
            function calculateAttendanceMetrics(stdId, period = state.currentPeriod) {
                if (!state.attendance[state.currentLevel] || !state.attendance[state.currentLevel][period]) {
                    return { ai: 0, aj: 0, t: 0, grade: 100, percentage: 10 };
                }
                const periodData = state.attendance[state.currentLevel][period];
                let totalLessons = 0;
                let presentLessons = 0;
                let ai = 0;
                let aj = 0;
                let t = 0;

                Object.keys(periodData).forEach(date => {
                    const dayData = periodData[date];
                    const stdData = dayData.students[stdId];
                    if (stdData) {
                        const lessons = parseInt(stdData.lessons) || 0;
                        const status = stdData.status;

                        totalLessons += lessons;

                        if (status === 'P' || status === 'T') {
                            presentLessons += lessons;
                        }

                        if (status === 'AI') ai += lessons; // Count as lessons missed
                        if (status === 'AJ') aj += lessons;
                        if (status === 'T') t += 1; // Count incidents of tardiness
                    }
                });

                let grade = 100;
                if (totalLessons > 0) {
                    grade = (presentLessons / totalLessons) * 100;
                }

                // Weight
                const isUpper = ['10', '11'].includes(state.currentLevel);
                const weight = 5; // Fixed 5% for custom setting?
                const percentage = (grade * weight) / 100;

                return { ai, aj, t, grade, percentage, totalLessons };
            }
            function renderAttendanceView() {
                const dateInput = document.getElementById('att-date');
                const date = dateInput.value;
                if (!date) return;

                if (!state.attendance[state.currentLevel]) state.attendance[state.currentLevel] = {};
                if (!state.attendance[state.currentLevel][state.currentPeriod]) state.attendance[state.currentLevel][state.currentPeriod] = {};

                const periodData = state.attendance[state.currentLevel][state.currentPeriod];
                if (!periodData[date]) {
                    // Init new date
                    const defaultLessons = parseInt(document.getElementById('att-total-lessons').value) || 2;
                    periodData[date] = { totalLessons: defaultLessons, students: {} };
                }

                const dayData = periodData[date];
                // Sync lessons input
                document.getElementById('att-total-lessons').value = dayData.totalLessons;

                // Calculate Total Period Lessons
                const totalPeriodLessons = Object.values(periodData).reduce((sum, d) => sum + (parseInt(d.totalLessons) || 0), 0);
                if (document.getElementById('att-period-total-badge')) {
                    document.getElementById('att-period-total-badge').innerText = totalPeriodLessons;
                }

                const students = state.students[state.currentLevel] || [];
                const tbody = document.getElementById('attendance-list');

                tbody.innerHTML = students.map(s => {
                    const status = (dayData.students[s.id] && dayData.students[s.id].status) ? dayData.students[s.id].status : 'P';
                    const lessons = (dayData.students[s.id] && dayData.students[s.id].lessons) ? dayData.students[s.id].lessons : dayData.totalLessons;

                    // Auto-init payload if missing
                    if (!dayData.students[s.id]) dayData.students[s.id] = { status: 'P', lessons: dayData.totalLessons };

                    // Colors
                    const statusColors = { 'P': 'bg-emerald-100 text-emerald-800', 'AI': 'bg-red-100 text-red-800', 'AJ': 'bg-blue-100 text-blue-800', 'T': 'bg-yellow-100 text-yellow-800' };

                    // Calculate Cumulative Stats
                    const stats = calculateAttendanceMetrics(s.id);

                    return `<tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0 group">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700 sticky left-0 bg-white group-hover:bg-gray-50 transition-colors z-20 shadow-sm">${s.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex gap-1">
                                <button onclick="app.setAttStatus('${date}', '${s.id}', 'P')" 
                                    class="px-3 py-1 text-xs font-bold rounded-l-lg border border-emerald-200 transition-all ${status === 'P' ? 'bg-emerald-500 text-white shadow-md' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}">P</button>
                                <button onclick="app.setAttStatus('${date}', '${s.id}', 'AI')" 
                                    class="px-3 py-1 text-xs font-bold border-t border-b border-r border-red-200 transition-all ${status === 'AI' ? 'bg-red-500 text-white shadow-md' : 'bg-red-50 text-red-600 hover:bg-red-100'}">AI</button>
                                <button onclick="app.setAttStatus('${date}', '${s.id}', 'AJ')" 
                                    class="px-3 py-1 text-xs font-bold border-t border-b border-r border-blue-200 transition-all ${status === 'AJ' ? 'bg-blue-500 text-white shadow-md' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}">AJ</button>
                                <button onclick="app.setAttStatus('${date}', '${s.id}', 'T')" 
                                    class="px-3 py-1 text-xs font-bold rounded-r-lg border-t border-b border-r border-yellow-200 transition-all ${status === 'T' ? 'bg-yellow-500 text-white shadow-md' : 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100'}">T</button>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" min="1" max="10" value="${lessons}" onchange="app.updateAttLessonCount('${date}', '${s.id}', this.value)" class="w-16 px-2 py-1 border border-gray-200 rounded-lg text-sm text-center font-bold text-gray-600 focus:outline-none focus:border-brand-500">
                        </td>
                        <td class="px-4 py-4 text-center text-xs font-bold text-red-400">${stats.ai}</td>
                        <td class="px-4 py-4 text-center text-xs font-bold text-blue-400">${stats.aj}</td>
                        <td class="px-4 py-4 text-center text-xs font-bold text-yellow-400">${stats.t}</td>
                        <td class="px-4 py-4 text-center font-bold text-brand-600">${stats.percentage.toFixed(1)}%</td>
                    </tr>`
                }).join('');
                saveData();
            }
            function setAttStatus(date, stdId, status) {
                const periodData = state.attendance[state.currentLevel][state.currentPeriod];
                if (!periodData[date]) return;
                if (!periodData[date].students[stdId]) periodData[date].students[stdId] = { status: 'P', lessons: periodData[date].totalLessons };
                periodData[date].students[stdId].status = status;
                saveData();
                renderAttendanceView(); // Re-render to update colors
            }

            function updateAttLessonCount(date, stdId, count) {
                const periodData = state.attendance[state.currentLevel][state.currentPeriod];
                if (!periodData[date]) return;
                if (!periodData[date].students[stdId]) periodData[date].students[stdId] = { status: 'P', lessons: periodData[date].totalLessons };
                periodData[date].students[stdId].lessons = parseInt(count);
                saveData();
            }

            function deleteAttendanceDate() {
                const date = document.getElementById('att-date').value;
                if (!date) return;

                if (!confirm(`¿Estás seguro de eliminar el registro de asistencia del ${date}? Esta acción no se puede deshacer.`)) return;

                if (state.attendance[state.currentLevel] && state.attendance[state.currentLevel][state.currentPeriod] && state.attendance[state.currentLevel][state.currentPeriod][date]) {
                    delete state.attendance[state.currentLevel][state.currentPeriod][date];
                    saveData();
                    // Reset view or clear inputs
                    document.getElementById('att-date').value = '';
                    renderAttendanceView();
                    alert('Registro eliminado correctamente.');
                }
            }

            function renderAttendanceSummary() {
                const container = document.getElementById('att-summary-table-container');
                if (!container) return;

                if (!state.attendance[state.currentLevel]) state.attendance[state.currentLevel] = {};
                if (!state.attendance[state.currentLevel][state.currentPeriod]) state.attendance[state.currentLevel][state.currentPeriod] = {};

                const periodData = state.attendance[state.currentLevel][state.currentPeriod];
                const dates = Object.keys(periodData).sort();
                const students = state.students[state.currentLevel] || [];

                if (dates.length === 0) {
                    container.innerHTML = `<div class="text-center py-12"><p class="text-gray-400 font-medium">No hay registros de asistencia en este periodo.</p></div>`;
                    return;
                }

                // Build Table
                let html = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-100 border border-gray-100 rounded-lg">`;

                // Header
                html += `<thead class="bg-gray-50"><tr>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 border-r border-gray-200">Estudiante</th>`;

                dates.forEach(d => {
                    // Format date MM-DD
                    const dateObj = new Date(d); // Note: Timezone issues might occur, better use simple string split
                    const [year, month, day] = d.split('-');
                    html += `<th class="px-2 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider border-r border-gray-100 min-w-[60px] bg-gray-50">
                        <div class="truncate w-full" title="${d}">${day}/${month}</div>
                    </th>`;
                });

                html += `<th class="px-4 py-3 text-center text-xs font-bold text-red-500 uppercase bg-red-50/30">AI</th>
                         <th class="px-4 py-3 text-center text-xs font-bold text-blue-500 uppercase bg-blue-50/30">AJ</th>
                         <th class="px-4 py-3 text-center text-xs font-bold text-yellow-500 uppercase bg-yellow-50/30">T</th>
                         <th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase bg-emerald-50/30">% (10%)</th>
                         </tr></thead>`;

                // Body
                html += `<tbody class="bg-white divide-y divide-gray-50">`;

                html += students.map(s => {
                    const stats = calculateAttendanceMetrics(s.id);

                    let cells = dates.map(d => {
                        const dayData = periodData[d];
                        const stdData = dayData.students[s.id];
                        const status = stdData ? stdData.status : '-';

                        let colorClass = 'text-gray-300';
                        let label = '-';

                        if (status === 'P') { colorClass = 'text-emerald-600 bg-emerald-50 font-bold'; label = 'P'; }
                        if (status === 'AI') { colorClass = 'text-red-600 bg-red-50 font-bold'; label = 'AI'; }
                        if (status === 'AJ') { colorClass = 'text-blue-600 bg-blue-50 font-bold'; label = 'AJ'; }
                        if (status === 'T') { colorClass = 'text-yellow-600 bg-yellow-50 font-bold'; label = 'T'; }

                        return `<td class="px-2 py-3 text-center text-xs border-r border-gray-50">
                            <span class="${colorClass} px-2 py-1 rounded block w-full">${label}</span>
                        </td>`;
                    }).join('');

                    return `<tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                        <td class="px-4 py-3 text-sm font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-100 shadow-sm z-20">${s.name}</td>
                        ${cells}
                        <td class="px-4 py-3 text-center text-xs font-bold text-red-400">${stats.ai}</td>
                        <td class="px-4 py-3 text-center text-xs font-bold text-blue-400">${stats.aj}</td>
                        <td class="px-4 py-3 text-center text-xs font-bold text-yellow-400">${stats.t}</td>
                        <td class="px-4 py-3 text-center font-bold text-brand-600">${stats.percentage.toFixed(1)}%</td>
                    </tr>`;
                }).join('');

                html += `</tbody></table></div>`;
                container.innerHTML = html;
            }

            // COTIDIANO LOGIC
            let currentEditingActivityId = null;
            function renderCotidianoPanel() {
                if (!state.cotidiano[state.currentLevel]) state.cotidiano[state.currentLevel] = {};
                if (!state.cotidiano[state.currentLevel][state.currentPeriod]) state.cotidiano[state.currentLevel][state.currentPeriod] = { activities: [], grades: {} };

                const list = document.getElementById('cotidiano-activities-list');
                const acts = state.cotidiano[state.currentLevel][state.currentPeriod].activities;

                list.innerHTML = acts.map(act => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-lg transition-all group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                             <button onclick="app.openActivityEditor('${act.id}')" class="p-2 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100" title="Editar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                             <button onclick="app.deleteActivity('${act.id}')" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100" title="Eliminar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2 truncate pr-20">${act.name}</h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${act.dates.map(d => `<span class="px-2 py-1 bg-blue-50 text-blue-700 text-xs font-bold rounded-lg">${d}</span>`).join('')}
                        </div>
                        <div class="space-y-1 mb-4">
                             ${act.skills.map(s => `<div class="text-xs text-gray-500 truncate flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gray-300"></span>${s.name} (${s.indicators.length} ind)</div>`).join('')}
                        </div>
                        <button onclick="app.openEvaluator('${act.id}')" class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold text-sm hover:bg-slate-700 shadow-lg shadow-slate-800/10 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Calificar
                        </button>
                    </div>
                `).join('');
            }

            function openActivityEditor(actId) {
                currentEditingActivityId = actId;
                const editor = document.getElementById('activity-editor');
                const isEdit = !!actId;

                editor.querySelector('h3').innerText = isEdit ? 'Editar Actividad' : 'Nueva Actividad';
                const delBtn = document.getElementById('btn-delete-activity');
                if (delBtn) delBtn.style.display = isEdit ? 'block' : 'none';

                if (isEdit) {
                    const act = state.cotidiano[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);
                    if (act) {
                        document.getElementById('act-name').value = act.name;

                        const datesContainer = document.getElementById('act-dates-list');
                        datesContainer.innerHTML = '';
                        act.dates.forEach(d => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-2 mb-2';
                            div.innerHTML = `<input type="date" value="${d}" class="p-2 border rounded-lg text-sm"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-2">×</button>`;
                            datesContainer.appendChild(div);
                        });

                        const skillsContainer = document.getElementById('act-skills-list');
                        skillsContainer.innerHTML = '';
                        act.skills.forEach(s => {
                            const div = document.createElement('div');
                            div.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200 mb-3';
                            div.innerHTML = `
                                <div class="mb-2">
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Indicador / Habilidad Base</label>
                                    <input type="text" value="${s.name}" class="w-full p-2 border rounded-lg font-bold text-sm text-slate-700" placeholder="Ej: Aplica conceptos de...">
                                </div>
                                <div class="pl-4 border-l-2 border-brand-200 space-y-2">
                                    <label class="block text-xs font-bold text-gray-400 uppercase">Criterios de Evaluación</label>
                                    <div class="indicators-list space-y-2">
                                        ${s.indicators.map(ind => `
                                            <div class="flex gap-2">
                                                <input type="text" value="${ind}" class="flex-1 p-2 border rounded-lg text-xs" placeholder="Criterio específico">
                                                <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600">×</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button type="button" onclick="app.addIndicator(this)" class="text-xs font-bold text-brand-600 hover:text-brand-700 flex items-center gap-1 mt-2">
                                        + Agregar Criterio
                                    </button>
                                </div>
                                <div class="mt-2 text-right">
                                    <button onclick="this.parentElement.remove()" class="text-xs text-red-500 hover:text-red-700 font-medium">Eliminar Habilidad</button>
                                </div>
                            `;
                            skillsContainer.appendChild(div);
                        });
                    }
                } else {
                    document.getElementById('act-name').value = '';
                    document.getElementById('act-dates-list').innerHTML = '';
                    document.getElementById('act-skills-list').innerHTML = '';
                    // Add one default slot
                    addActivityDate();
                    addActivitySkill();
                }

                editor.classList.remove('hidden');
            }

            function closeActivityEditor() {
                document.getElementById('activity-editor').classList.add('hidden');
                currentEditingActivityId = null;
            }

            function addActivityDate() {
                const container = document.getElementById('act-dates-list');
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2';
                div.innerHTML = `<input type="date" class="p-2 border rounded-lg text-sm"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-2">×</button>`;
                container.appendChild(div);
            }

            function addActivitySkill() {
                const container = document.getElementById('act-skills-list');
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200 mb-3';
                div.innerHTML = `
                    <div class="mb-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Indicador / Habilidad Base</label>
                        <input type="text" class="w-full p-2 border rounded-lg font-bold text-sm text-slate-700" placeholder="Ej: Aplica conceptos de...">
                    </div>
                    <div class="pl-4 border-l-2 border-brand-200 space-y-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase">Criterios de Evaluación</label>
                        <div class="indicators-list space-y-2">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 border rounded-lg text-xs" placeholder="Criterio específico">
                                <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600">×</button>
                            </div>
                        </div>
                        <button type="button" onclick="app.addIndicator(this)" class="text-xs font-bold text-brand-600 hover:text-brand-700 flex items-center gap-1 mt-2">
                            + Agregar Criterio
                        </button>
                    </div>
                    <div class="mt-2 text-right">
                        <button onclick="this.parentElement.remove()" class="text-xs text-red-500 hover:text-red-700 font-medium">Eliminar Habilidad</button>
                    </div>
                `;
                container.appendChild(div);
            }

            function addIndicator(btn) {
                const list = btn.previousElementSibling;
                const div = document.createElement('div');
                div.className = 'flex gap-2';
                div.innerHTML = `<input type="text" class="flex-1 p-2 border rounded-lg text-xs" placeholder="Criterio específico"><button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600">×</button>`;
                list.appendChild(div);
            }

            function saveActivity() {
                const name = document.getElementById('act-name').value;
                if (!name) return alert('El nombre es requerido');

                // Collect Dates
                const dates = Array.from(document.querySelectorAll('#act-dates-list input[type="date"]'))
                    .map(i => i.value).filter(val => val);

                if (dates.length === 0) return alert('Debes agregar al menos una fecha');

                // Collect Skills
                const skillsEls = document.querySelectorAll('#act-skills-list > div');
                const skills = [];

                skillsEls.forEach(el => {
                    const skillName = el.querySelector('input[placeholder^="Ej: Aplica"]').value;
                    if (!skillName) return;

                    const indicators = Array.from(el.querySelectorAll('.indicators-list input'))
                        .map(i => i.value).filter(val => val);

                    if (indicators.length > 0) {
                        skills.push({ name: skillName, indicators });
                    }
                });

                if (skills.length === 0) return alert('Debes agregar al menos una habilidad con criterios');

                // Save to State
                if (!state.cotidiano[state.currentLevel]) state.cotidiano[state.currentLevel] = {};
                if (!state.cotidiano[state.currentLevel][state.currentPeriod])
                    state.cotidiano[state.currentLevel][state.currentPeriod] = { activities: [], grades: {} };

                const periodData = state.cotidiano[state.currentLevel][state.currentPeriod];

                if (currentEditingActivityId) {
                    const idx = periodData.activities.findIndex(a => a.id === currentEditingActivityId);
                    if (idx !== -1) {
                        periodData.activities[idx] = { ...periodData.activities[idx], name, dates, skills };
                    }
                } else {
                    const newId = Date.now().toString();
                    periodData.activities.push({ id: newId, name, dates, skills });

                    // Init grades structure for new activity? Not strictly needed, created on demand.
                }

                saveData();
                closeActivityEditor();
                renderCotidianoPanel();
            }

            function deleteActivity(actId) {
                if (!confirm('¿Estás seguro de eliminar esta actividad? Se perderán las calificaciones asociadas.')) return;

                const periodData = state.cotidiano[state.currentLevel][state.currentPeriod];
                periodData.activities = periodData.activities.filter(a => a.id !== actId);
                if (periodData.grades && periodData.grades[actId]) delete periodData.grades[actId];

                saveData();
                renderCotidianoPanel();
            }

            function calculateCotidianoMetrics(stdId, period = state.currentPeriod) {
                const levelData = state.cotidiano[state.currentLevel] || {};
                const periodData = levelData[period] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const grades = periodData.grades || {};

                // Attendance Data
                const attPeriodData = state.attendance[state.currentLevel] && state.attendance[state.currentLevel][period] ? state.attendance[state.currentLevel][period] : {};

                let totalPointsPossible = 0;
                let totalPointsObtained = 0;

                activities.forEach(act => {
                    // Check Exemption: Absent on ALL dates?
                    const allAbsent = act.dates.every(d => {
                        const dayAtt = attPeriodData[d];
                        if (!dayAtt) return false; // No attendance record for date -> Not absent
                        const stdAtt = dayAtt.students[stdId];
                        return stdAtt && (stdAtt.status === 'AI' || stdAtt.status === 'AJ') && (dayAtt.totalLessons > 0 && stdAtt.lessons >= dayAtt.totalLessons);
                    });

                    if (allAbsent) return; // Skip this activity

                    const actGrades = grades[act.id] || {};
                    const stdGrades = actGrades[stdId] || {};

                    act.skills.forEach((s, si) => {
                        s.indicators.forEach((_, ii) => {
                            const iId = `${si}-${ii}`;
                            const scores = Object.values(stdGrades[iId] || {});
                            const score = scores.length > 0 ? Math.max(...scores) : 0;
                            totalPointsObtained += score;
                            totalPointsPossible += 3; // Max scale
                        });
                    });
                });

                let grade = 0;
                if (totalPointsPossible > 0) grade = (totalPointsObtained / totalPointsPossible) * 100;
                // If exempt from everything, grade remains 0 (or should it be null? User said "ignorar").
                // If 0/0, it is 0. 

                // Weight
                const isUpper = ['10', '11'].includes(state.currentLevel);
                const weight = isUpper ? 35 : 45;
                const percentage = (grade * weight) / 100;

                return { grade, percentage };
            }

            // EVALUATOR LOGIC
            let curEvalActId = null;
            // --- EVALUADOR COMPARTIDO (SOLUCIÓN AL ERROR) ---

            function openEvaluator(actId) { // Para Cotidiano
                currentEditingTareaId = null; // RESET DE TAREAS
                curEvalActId = actId;
                const act = state.cotidiano[state.currentLevel][state.currentPeriod].activities.find(a => a.id === actId);
                if (!act) return;

                document.getElementById('evaluator-view').classList.remove('hidden');
                document.getElementById('eval-title').innerText = `Calificando: ${act.name}`;

                // Populate Dates
                const sel = document.getElementById('eval-date-selector');
                sel.innerHTML = act.dates.map(d => `<option value="${d}">${d}</option>`).join('');

                // Add Change Listener
                sel.onchange = () => renderEvaluatorGrid(act);

                // Render Grid
                renderEvaluatorGrid(act);
            }


            function openTareaEvaluator(tareaId) { // Para Tareas
                curEvalActId = null; // RESET DE COTIDIANO
                currentEditingTareaId = tareaId;
                const act = state.tareas[state.currentLevel][state.currentPeriod].activities.find(a => a.id === tareaId);
                if (!act) {
                    console.error('Activity not found for tareaId:', tareaId);
                    return;
                }
                console.log('Activity found:', act);

                // Validate dates array
                if (!act.dates || act.dates.length === 0) {
                    alert('Esta tarea no tiene fechas asignadas. Por favor, edita la tarea y agrega al menos una fecha.');
                    return;
                }

                // Initialize grades structure if needed
                if (!state.tareas[state.currentLevel][state.currentPeriod].grades) {
                    state.tareas[state.currentLevel][state.currentPeriod].grades = {};
                }
                if (!state.tareas[state.currentLevel][state.currentPeriod].grades[tareaId]) {
                    state.tareas[state.currentLevel][state.currentPeriod].grades[tareaId] = {};
                }

                // Reuse generic evaluator container but likely specific render
                const evaluatorView = document.getElementById('evaluator-view');
                evaluatorView.classList.remove('hidden-view', 'hidden');
                document.getElementById('eval-title').innerText = `Evaluando: ${act.name}`;
                // Setup date selector for Tareas
                const dateSel = document.getElementById('eval-date-selector');
                dateSel.innerHTML = act.dates.map(d => `<option value="${d}">${d}</option>`).join('');
                dateSel.value = act.dates[0]; // Default to first
                dateSel.disabled = false;
                dateSel.onchange = renderTareasEvaluatorGrid; // Bind to Tareas render

                console.log('About to call renderTareasEvaluatorGrid');
                renderTareasEvaluatorGrid();
            }

            function closeEvaluator() {
                document.getElementById('evaluator-view').classList.add('hidden');
                document.getElementById('eval-date-selector').onchange = null;
                const prevView = currentEditingTareaId ? 'tareas-view' : 'cotidiano-view';
                curEvalActId = null;
                currentEditingTareaId = null;
                navigateTo(prevView);
            }



            function renderEvaluatorGrid(act) {
                const container = document.getElementById('evaluator-grid-container');
                const students = state.students[state.currentLevel] || [];
                const date = document.getElementById('eval-date-selector').value;
                const periodData = state.cotidiano[state.currentLevel][state.currentPeriod];
                const actGrades = (periodData.grades && periodData.grades[act.id]) ? periodData.grades[act.id] : {};

                // Attendance Data for this date
                const attPeriodData = state.attendance[state.currentLevel] && state.attendance[state.currentLevel][state.currentPeriod] ? state.attendance[state.currentLevel][state.currentPeriod] : {};
                const dayAttData = attPeriodData[date] || { students: {}, totalLessons: 0 };

                container.innerHTML = `<div class="flex flex-col gap-3">` + students.map(std => {
                    const stdGrades = actGrades[std.id] || {};

                    // Check Absence
                    let isAbsent = false;
                    const stdAtt = dayAttData.students[std.id];
                    if (stdAtt && (stdAtt.status === 'AI' || stdAtt.status === 'AJ')) {
                        if (dayAttData.totalLessons > 0 && stdAtt.lessons >= dayAttData.totalLessons) {
                            isAbsent = true;
                        }
                    }

                    // Calculate Summary Stats
                    let totalPts = 0;
                    let maxPts = 0;
                    act.skills.forEach((s, si) => s.indicators.forEach((ind, ii) => {
                        maxPts += 3;
                        const iId = `${si}-${ii}`;
                        if (stdGrades[iId]) {
                            const scores = Object.values(stdGrades[iId]);
                            if (scores.length) totalPts += Math.max(...scores);
                        }
                    }));

                    const grade0to3 = maxPts > 0 ? Math.round((totalPts / maxPts) * 3) : 0;
                    const gradeColor = grade0to3 >= 3 ? 'text-green-600 bg-green-50' : (grade0to3 >= 2 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50');

                    // Indicators Generation
                    const indicatorsHTML = act.skills.map((skill, sIdx) => {
                        return skill.indicators.map((ind, iIdx) => {
                            const indId = `${sIdx}-${iIdx}`;
                            const savedVal = (stdGrades[indId] && stdGrades[indId][date] !== undefined) ? stdGrades[indId][date] : -1;

                            return `
                            <div class="bg-gray-50 rounded-lg p-2 border border-gray-100 flex-1 min-w-[200px] ${isAbsent ? 'opacity-50 grayscale' : ''}">
                                <p class="text-[10px] text-gray-500 mb-1 font-bold truncate" title="${ind}">${ind}</p>
                                <div class="flex gap-1" id="btn-group-${std.id}-${indId}">
                                    ${[0, 1, 2, 3].map(val => {
                                let btnClass = '';
                                if (val === savedVal) {
                                    if (val === 0) btnClass = 'bg-gray-500 text-white border-gray-600 scale-105 shadow-sm';
                                    if (val === 1) btnClass = 'bg-red-500 text-white border-red-600 scale-105 shadow-sm';
                                    if (val === 2) btnClass = 'bg-yellow-500 text-white border-yellow-600 scale-105 shadow-sm';
                                    if (val === 3) btnClass = 'bg-green-500 text-white border-green-600 scale-105 shadow-sm';
                                } else {
                                    const hoverClass = val === 0 ? 'hover:bg-gray-100' :
                                        val === 1 ? 'hover:bg-red-50 hover:text-red-400' :
                                            val === 2 ? 'hover:bg-yellow-50 hover:text-yellow-400' :
                                                'hover:bg-green-50 hover:text-green-400';
                                    btnClass = `bg-white text-gray-300 ${hoverClass}`;
                                }

                                const disabledAttr = isAbsent ? 'disabled' : '';
                                const cursorClass = isAbsent ? 'cursor-not-allowed' : '';
                                const onClick = isAbsent ? '' : `onclick="app.setTempScore('${std.id}', '${indId}', ${val}, this)"`;

                                return `
                                        <button ${onClick} ${disabledAttr}
                                            class="flex-1 h-7 rounded text-xs font-bold border border-gray-200 transition-all ${btnClass} ${cursorClass}"
                                            data-val="${val}">
                                            ${val}
                                        </button>`;
                            }).join('')}
                                </div>
                            </div>`;
                        }).join('');
                    }).join('');

                    return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow flex flex-col md:flex-row items-center gap-4">
                        <div class="flex items-center gap-3 w-full md:w-1/4 min-w-[200px]">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-sm font-bold text-slate-500 shrink-0">
                                ${std.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm truncate">${std.name}</h4>
                                <div class="flex items-center gap-2">
                                     <p class="text-xs text-slate-400">ID: ${std.id}</p>
                                     <div class="flex gap-1" id="eval-badges-${std.id}">
                                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">Pts: ${totalPts}</span>
                                        <span class="text-xs font-bold ${gradeColor} px-1.5 py-0.5 rounded">Nota: ${grade0to3}</span>
                                        ${isAbsent ? '<span class="text-xs font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">AUSENTE</span>' : ''}
                                     </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
                            ${indicatorsHTML}
                        </div>
                    </div>`;
                }).join('') + `</div>`;
            }

            function setTempScore(stdId, indId, val, btnEl) {
                // UI Highlight Logic
                const parent = btnEl.parentElement;
                Array.from(parent.children).forEach(b => {
                    // Reset to base style + hover (simplified)
                    const v = parseInt(b.dataset.val);
                    const hover = v === 0 ? 'hover:bg-gray-100' :
                        v === 1 ? 'hover:bg-red-50 hover:text-red-400' :
                            v === 2 ? 'hover:bg-yellow-50 hover:text-yellow-400' :
                                'hover:bg-green-50 hover:text-green-400';
                    b.className = `flex-1 h-7 rounded text-xs font-bold border border-gray-200 transition-all bg-white text-gray-300 ${hover}`;
                });

                // Set Active Style
                let activeStyle = '';
                if (val === 0) activeStyle = 'bg-gray-500 text-white border-gray-600 scale-105 shadow-sm';
                if (val === 1) activeStyle = 'bg-red-500 text-white border-red-600 scale-105 shadow-sm';
                if (val === 2) activeStyle = 'bg-yellow-500 text-white border-yellow-600 scale-105 shadow-sm';
                if (val === 3) activeStyle = 'bg-green-500 text-white border-green-600 scale-105 shadow-sm';

                btnEl.className = `flex-1 h-7 rounded text-xs font-bold border transition-all ${activeStyle}`;

                // Persistence Logic
                if (!curEvalActId) return console.error("No active activity ID");
                const dateSel = document.getElementById('eval-date-selector');
                const date = dateSel ? dateSel.value : null;

                if (!date) return console.error("No date selected");

                // Update State Safely
                if (!state.cotidiano[state.currentLevel]) state.cotidiano[state.currentLevel] = {};
                const levelData = state.cotidiano[state.currentLevel];

                if (!levelData[state.currentPeriod]) levelData[state.currentPeriod] = { activities: [], grades: {} };
                const periodData = levelData[state.currentPeriod];

                if (!periodData.grades) periodData.grades = {};
                if (!periodData.grades[curEvalActId]) periodData.grades[curEvalActId] = {};

                const actGrades = periodData.grades[curEvalActId];
                if (!actGrades[stdId]) actGrades[stdId] = {};
                if (!actGrades[stdId][indId]) actGrades[stdId][indId] = {};

                actGrades[stdId][indId][date] = val;

                // Update Real-time Badge
                const act = periodData.activities.find(a => a.id === curEvalActId);
                if (act) {
                    let newTotal = 0;
                    let newMax = 0;
                    const sGrades = actGrades[stdId];
                    act.skills.forEach((s, si) => s.indicators.forEach((ind, ii) => {
                        newMax += 3;
                        const iId = `${si}-${ii}`;
                        if (sGrades[iId]) {
                            const scores = Object.values(sGrades[iId]);
                            if (scores.length) newTotal += Math.max(...scores);
                        }
                    }));

                    const grade0to3 = newMax > 0 ? Math.round((newTotal / newMax) * 3) : 0;
                    const gradeColor = grade0to3 >= 3 ? 'text-green-600 bg-green-50' : (grade0to3 >= 2 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50');

                    const badgeContainer = document.getElementById(`eval-badges-${stdId}`);
                    if (badgeContainer) {
                        badgeContainer.innerHTML = `
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">Pts: ${newTotal}</span>
                            <span class="text-xs font-bold ${gradeColor} px-1.5 py-0.5 rounded">Nota: ${grade0to3}</span>
                        `;
                    }
                }

                // Recalculate Student Average
                const metrics = calculateCotidianoMetrics(stdId);
                const student = state.students[state.currentLevel].find(s => s.id === stdId);
                const pKey = `p${state.currentPeriod}`;
                if (student) {
                    if (!student.grades) student.grades = { p1: {}, p2: {} };
                    if (!student.grades[pKey]) student.grades[pKey] = {};
                    student.grades[pKey].cotidiano = metrics.grade;
                }

                saveData();

                // Visual Feedback
                const saveStatus = document.getElementById('save-status');
                if (saveStatus) {
                    saveStatus.classList.remove('opacity-0');
                    saveStatus.classList.add('opacity-100');
                    setTimeout(() => {
                        saveStatus.classList.remove('opacity-100');
                        saveStatus.classList.add('opacity-0');
                    }, 1000);
                }
            }

            function renderCotidianoSummaryReport() {
                const levelData = state.cotidiano[state.currentLevel] || {};
                const periodData = levelData[state.currentPeriod] || { activities: [], grades: {} };
                const activities = periodData.activities || [];
                const students = state.students[state.currentLevel] || [];

                // Badges
                if (document.getElementById('cs-level-badge')) document.getElementById('cs-level-badge').innerText = `Nivel ${state.currentLevel}`;
                if (document.getElementById('cs-period-badge')) document.getElementById('cs-period-badge').innerText = state.currentPeriod;

                const headerRow = document.getElementById('cs-table-header');
                const body = document.getElementById('cs-table-body');

                if (!headerRow || !body) return;

                // 1. Build Header
                let headersHTML = `<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 border-r border-gray-200">Estudiante</th>`;

                activities.forEach(act => {
                    headersHTML += `<th class="px-2 py-3 text-center text-xs font-bold text-slate-700 uppercase tracking-wider border-r border-gray-100 min-w-[100px] bg-gray-50">
                        <div class="truncate w-full" title="${act.name}">${act.name}</div>
                    </th>`;
                });

                headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-brand-600 uppercase tracking-wider bg-blue-50 border-l border-blue-100">Nota Final</th>`;
                headersHTML += `<th class="px-4 py-3 text-center text-xs font-bold text-emerald-600 uppercase tracking-wider bg-emerald-50 border-l border-emerald-100">%</th>`;

                headerRow.innerHTML = headersHTML;

                // Attendance Data for Exemption Checks
                const attPeriodData = state.attendance[state.currentLevel] && state.attendance[state.currentLevel][state.currentPeriod] ? state.attendance[state.currentLevel][state.currentPeriod] : {};

                // 2. Build Rows
                body.innerHTML = students.map(s => {
                    // Use shared metrics for final calculation to guarantee consistency
                    const metrics = calculateCotidianoMetrics(s.id);

                    const cellsHTML = activities.map(act => {
                        // Check Absence Exemption
                        const allAbsent = act.dates.every(d => {
                            const dayAtt = attPeriodData[d];
                            if (!dayAtt) return false;
                            const stdAtt = dayAtt.students[s.id];
                            return stdAtt && (stdAtt.status === 'AI' || stdAtt.status === 'AJ') && (dayAtt.totalLessons > 0 && stdAtt.lessons >= dayAtt.totalLessons);
                        });

                        if (allAbsent) {
                            return `<td class="px-2 py-3 text-center text-sm font-bold border-r border-gray-50">
                                <span class="bg-gray-100 text-gray-400 px-2 py-1 rounded mx-auto block w-max text-xs">N/A</span>
                            </td>`;
                        }

                        const actGrades = periodData.grades[act.id] || {};
                        const stdGrades = actGrades[s.id] || {};

                        // Calculate Act Score specific to this activity
                        let actObtained = 0;
                        let actPossible = 0;

                        act.skills.forEach((skill, sIdx) => {
                            skill.indicators.forEach((_, iIdx) => {
                                const indId = `${sIdx}-${iIdx}`;
                                const scores = Object.values(stdGrades[indId] || {});
                                const best = scores.length > 0 ? Math.max(...scores) : 0;
                                actObtained += best;
                                actPossible += 3;
                            });
                        });

                        // Activity Grade (0-3 scale, rounded integer)
                        const actScaleScore = actPossible > 0 ? Math.round((actObtained / actPossible) * 3) : 0;

                        // Thresholds: 3 (Green), 2 (Yellow), 0-1 (Red)
                        const colorClass = actScaleScore >= 3 ? 'text-green-600 bg-green-50' : (actScaleScore >= 2 ? 'text-yellow-600 bg-yellow-50' : 'text-red-600 bg-red-50');

                        return `<td class="px-2 py-3 text-center text-sm font-bold border-r border-gray-50">
                            <span class="${colorClass} px-2 py-1 rounded mx-auto block w-max" title="Puntos: ${actObtained}/${actPossible}">${actScaleScore}</span>
                        </td>`;
                    }).join('');

                    return `
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                            <td class="px-4 py-3 text-sm font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-100 shadow-sm z-20">${s.name}</td>
                            ${cellsHTML}
                            <td class="px-4 py-3 text-center font-bold text-brand-700 bg-blue-50/20 border-l border-blue-50">${metrics.grade.toFixed(1)}</td>
                            <td class="px-4 py-3 text-center font-extrabold text-emerald-700 bg-emerald-50/20 border-l border-emerald-50">${metrics.percentage.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');
            }

            function exportCSV() {
                const students = state.students[state.currentLevel] || [];
                if (students.length === 0) return alert('No hay datos para exportar en este nivel.');

                // Headers
                let csvContent = "Id;Nombre;Trabajo cotidiano;Tareas;Prueba;Asistencia\n";

                // Rows
                students.forEach(s => {
                    // Calculate Metrics
                    const cotidiano = calculateCotidianoMetrics(s.id).percentage.toFixed(2).replace('.', ',');
                    const att = calculateAttendanceMetrics(s.id).percentage.toFixed(2).replace('.', ',');
                    const tareas = calculateTareasMetrics(s.id).percentage.toFixed(2).replace('.', ',');

                    // Placeholders for Pruebas until logic is fully implemented
                    const pruebas = calculatePruebasMetrics(s.id).percentage.toFixed(2).replace('.', ',');

                    const row = [
                        s.id,
                        `"${s.name}"`,
                        cotidiano,
                        tareas,
                        pruebas,
                        att
                    ].join(";");
                    csvContent += row + "\n";
                });

                // Trigger Download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `registro_2026_nivel_${state.currentLevel}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }



            // Expose methods
            return {
                init, navigateTo, setPeriod, addStudentManual, deleteStudent, exportCSV, downloadTemplate, getStudent, renderUI,
                renderAttendanceView, setAttStatus, updateAttLessonCount, deleteAttendanceDate, renderAttendanceSummary,
                renderCotidianoPanel, openActivityEditor, closeActivityEditor, saveActivity, deleteActivity,
                addActivityDate, addActivitySkill, addIndicator,
                openEvaluator, closeEvaluator, setTempScore, renderCotidianoSummaryReport,
                // TAREAS EXPORTS
                renderTareasPanel, openTareaEditor, closeTareaEditor, saveTarea, deleteTarea,
                openTareaEvaluator, setTareaScore, renderTareasEvaluatorGrid, renderTareasSummaryReport, calculateTareasMetrics,
                addTareaDate, addTareaSkill, addTareaIndicator, deleteTareaDate, deleteTareaSkill, deleteTareaIndicator,
                updateIndicatorPoints, saveTareaObservation, toggleTareaDelivery,
                // PRUEBAS EXPORTS
                renderPruebasPanel, openPruebasEditor, closePruebasEditor, savePrueba, deletePrueba,
                openPruebasEvaluator, closePruebasEvaluator, renderPruebasEvaluatorGrid, setPruebaScore,
                togglePruebaAS, setPruebaOverride, calculatePruebasMetrics: calculatePruebasMetricsV2, renderPruebasSummaryReport
            };
        })();

        window.app = app; // Expose app globally for onclick handlers
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>

</html>
<!-- SPLIT_MARKER_END -->